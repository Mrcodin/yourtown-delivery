<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Hometown Delivery</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="loading.css">
    <link rel="stylesheet" href="toast.css">
    <link rel="stylesheet" href="back-to-top.css">
    <link rel="stylesheet" href="card-hover.css">
    <link rel="stylesheet" href="mobile-touch.css">
    <link rel="stylesheet" href="mobile-improvements.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="api.js"></script>
    <script src="customer-auth.js"></script>
    <script src="loading.js"></script>
    <script src="toast.js"></script>
    <script src="config.js"></script>
    <script src="page-config.js"></script>
</head>
<body>
    <!-- ACCESSIBILITY TOOLBAR -->
    <div class="accessibility-bar">
        <div class="container accessibility-container">
            <span>Accessibility:</span>
            <button onclick="toggleLargeText()" id="text-size-btn" class="access-btn">üî§ Larger Text</button>
            <button onclick="toggleContrast()" id="contrast-btn" class="access-btn">üåì High Contrast</button>
            <button onclick="speakPage()" id="speak-btn" class="access-btn">üîä Read Aloud</button>
        </div>
    </div>

    <!-- PHONE BAR -->
    <div class="phone-bar">
        <div class="container">
            üìû <strong>Need help?</strong> 
            <a href="tel:555-123-4567">555-123-4567</a> | 
            Mon-Fri 8am-6pm, Sat 9am-3pm
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="container header-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">üõí</span>
                <span class="logo-text">Hometown Delivery</span>
            </a>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
            <nav class="nav" id="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="shop.html" class="nav-link">Shop Groceries</a>
                <a href="cart.html" class="nav-link">
                    üõí Cart (<span id="cart-count">0</span>)
                </a>
                <a href="track.html" class="nav-link">Track Order</a>
                <a href="about.html" class="nav-link">About Us</a>
                <a href="customer-account.html" class="nav-link active">My Account</a>
                <a href="#" onclick="customerAuth.logout(); return false;" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="account-page">
        <div class="container">
            <div class="page-header-large">
                <h1>üëã Welcome Back!</h1>
                <p class="subtitle">Manage your account and view your orders</p>
            </div>

            <!-- Email Verification Banner -->
            <div id="verification-banner" class="verification-banner" style="display: none;">
                <div class="verification-content">
                    <span class="verification-icon">‚ö†Ô∏è</span>
                    <div class="verification-message">
                        <strong>Email Verification Required</strong>
                        <p>Please verify your email address to place orders. Check your inbox for the verification link.</p>
                    </div>
                    <button id="resend-verification-btn" class="btn-secondary-small">Resend Email</button>
                </div>
            </div>

            <!-- Large Tab Buttons -->
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="profile">
                    <span class="tab-icon">üë§</span>
                    <span class="tab-text">My Profile</span>
                </button>
                <button class="tab-btn" data-tab="orders">
                    <span class="tab-icon">üì¶</span>
                    <span class="tab-text">My Orders</span>
                </button>
                <button class="tab-btn" data-tab="usual-orders">
                    <span class="tab-icon">‚≠ê</span>
                    <span class="tab-text">My Usual Orders</span>
                </button>
                <button class="tab-btn" data-tab="addresses">
                    <span class="tab-icon">üìç</span>
                    <span class="tab-text">Addresses</span>
                </button>
                <button class="tab-btn" data-tab="settings">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span class="tab-text">Settings</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="account-content">
                    <!-- Profile Tab -->
                    <div id="tab-profile" class="account-tab active">
                        <h2 class="section-title">üìã Your Information</h2>
                        <div class="profile-info-cards">
                            <div class="info-card">
                                <div class="info-icon">üë§</div>
                                <div class="info-details">
                                    <div class="info-label">Full Name</div>
                                    <div class="info-value" id="profile-name">--</div>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-icon">üìß</div>
                                <div class="info-details">
                                    <div class="info-label">Email Address</div>
                                    <div class="info-value" id="profile-email">--</div>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-icon">üìû</div>
                                <div class="info-details">
                                    <div class="info-label">Phone Number</div>
                                    <div class="info-value" id="profile-phone">--</div>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-icon">üìÖ</div>
                                <div class="info-details">
                                    <div class="info-label">Member Since</div>
                                    <div class="info-value" id="profile-since">--</div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-number" id="profile-orders">0</div>
                                <div class="stat-label">Total Orders</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="profile-spent">$0.00</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Tab -->
                    <div id="tab-orders" class="account-tab">
                        <h2 class="section-title">üì¶ Your Orders</h2>
                        <div id="orders-container">
                            <p class="loading-text-large">‚è≥ Loading your orders...</p>
                        </div>
                    </div>

                    <!-- Usual Orders Tab -->
                    <div id="tab-usual-orders" class="account-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                            <div style="color: white;">
                                <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                                    <span>‚≠ê</span> My Usual Orders
                                </h2>
                                <p style="margin: 0; font-size: 16px; opacity: 0.95;">Save your favorite orders for quick reordering</p>
                            </div>
                            <button onclick="showCreateUsualOrder()" style="padding: 14px 28px; font-size: 18px; font-weight: 600; border-radius: 8px; border: 2px solid white; background: white; color: #667eea; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.15)'">
                                <span style="font-size: 20px;">‚ûï</span>
                                <span>Create New</span>
                            </button>
                        </div>
                        
                        <div id="usual-orders-container">
                            <p class="loading-text-large">‚è≥ Loading saved orders...</p>
                        </div>
                    </div>

                    <!-- Addresses Tab -->
                    <div id="tab-addresses" class="account-tab">
                        <h2 class="section-title">üìç Delivery Addresses</h2>
                        <div id="addresses-container">
                            <div class="empty-state-large">
                                <div class="empty-icon">üìç</div>
                                <p>No addresses saved yet.</p>
                                <p class="empty-hint">Add an address to make checkout faster!</p>
                            </div>
                        </div>
                        <button class="btn-large btn-primary" onclick="showAddAddress()">
                            ‚ûï Add New Address
                        </button>
                    </div>

                    <!-- Settings Tab -->
                    <div id="tab-settings" class="account-tab">
                        <h2 class="section-title">‚öôÔ∏è Account Settings</h2>
                        
                        <!-- Profile Information -->
                        <div class="settings-section-large">
                            <h3 class="settings-heading">üë§ Profile Information</h3>
                            <form id="profile-form" class="form-large">
                                <div class="form-group-large">
                                    <label>Full Name</label>
                                    <input type="text" id="profile-name" required class="input-large">
                                </div>
                                <div class="form-group-large">
                                    <label>Email Address</label>
                                    <input type="email" id="profile-email" required class="input-large">
                                    <small class="input-hint">Used for order confirmations and receipts</small>
                                </div>
                                <div class="form-group-large">
                                    <label>Phone Number</label>
                                    <input type="tel" id="profile-phone" required class="input-large">
                                    <small class="input-hint">Used for order updates and delivery coordination</small>
                                </div>
                                <button type="submit" class="btn-large btn-primary">üíæ Save Changes</button>
                            </form>
                        </div>
                        
                        <div class="settings-section-large">
                            <h3 class="settings-heading">üîí Change Password</h3>
                            <form id="change-password-form" class="form-large">
                                <div class="form-group-large">
                                    <label>Current Password</label>
                                    <input type="password" id="current-password" required class="input-large">
                                </div>
                                <div class="form-group-large">
                                    <label>New Password</label>
                                    <input type="password" id="new-password" required minlength="6" class="input-large">
                                    <small class="input-hint">At least 6 characters</small>
                                </div>
                                <div class="form-group-large">
                                    <label>Confirm New Password</label>
                                    <input type="password" id="confirm-password" required class="input-large">
                                </div>
                                <button type="submit" class="btn-large btn-primary">üîÑ Update Password</button>
                            </form>
                        </div>

                        <div class="settings-section-large">
                            <h3 class="settings-heading">üîî Notification Preferences</h3>
                            <label class="checkbox-label-large">
                                <input type="checkbox" id="email-notifications" checked class="checkbox-large">
                                <span>üìß Receive email notifications about my orders</span>
                            </label>
                            <label class="checkbox-label-large">
                                <input type="checkbox" id="sms-notifications" class="checkbox-large">
                                <span>üí¨ Receive text message updates</span>
                            </label>
                            <button onclick="saveNotificationPreferences()" class="btn-large btn-secondary" style="margin-top: 15px;">
                                üíæ Save Preferences
                            </button>
                        </div>

                        <div class="logout-section">
                            <button class="btn-large btn-outline" onclick="customerAuth.logout()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- EDIT ORDER MODAL -->
    <div id="edit-order-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Order</h2>
                <span class="close" onclick="closeEditOrderModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="edit-order-loading" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p>Loading order...</p>
                </div>
                <div id="edit-order-content" style="display: none;">
                    <div class="order-info-banner" style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #92400e;">
                            ‚ö†Ô∏è You can modify this order until it's picked up by the driver.
                        </p>
                    </div>
                    <div id="edit-order-items"></div>
                    <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Subtotal:</span>
                            <span id="edit-subtotal">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Delivery Fee:</span>
                            <span id="edit-delivery-fee">$6.99</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Tip:</span>
                            <span id="edit-tip">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Tax:</span>
                            <span id="edit-tax">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; padding-top: 10px; border-top: 2px solid #d1d5db;">
                            <span>New Total:</span>
                            <span id="edit-total">$0.00</span>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Special Instructions</label>
                        <textarea id="edit-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="edit-order-footer" style="display: none;">
                <button onclick="closeEditOrderModal()" class="btn-large btn-outline">Cancel</button>
                <button onclick="saveOrderChanges()" class="btn-large btn-primary">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- CANCEL ORDER MODAL -->
    <div id="account-cancel-modal" class="modal-overlay" onclick="if(event.target === this) closeCancelModal()">
        <div class="modal" style="display: block; max-width: 500px; width: 90%; background: white; position: relative; z-index: 3001; box-shadow: 0 25px 50px rgba(0,0,0,0.3); padding: 40px; border-radius: 16px; transform: scale(1) !important;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">
                <h2 style="margin: 0; font-size: 24px; color: #1f2937;">Cancel Order</h2>
                <span class="close" onclick="closeCancelModal()" style="cursor: pointer; font-size: 32px; line-height: 1; color: #6b7280; font-weight: bold; transition: color 0.2s;" onmouseover="this.style.color='#dc2626'" onmouseout="this.style.color='#6b7280'">&times;</span>
            </div>
            <div class="modal-body" style="color: #1f2937;">
                <p style="margin-bottom: 20px; font-size: 16px;">
                    Are you sure you want to cancel this order? <strong>This action cannot be undone.</strong>
                </p>
                
                <label for="account-cancel-reason" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Please tell us why you're cancelling:
                </label>
                <select id="account-cancel-reason" class="form-input" style="width: 100%; margin-bottom: 20px;">
                    <option value="">-- Select a reason --</option>
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Ordered by mistake">Ordered by mistake</option>
                    <option value="Too expensive">Too expensive</option>
                    <option value="Taking too long">Taking too long</option>
                    <option value="other">Other (please specify)</option>
                </select>
                
                <div id="account-other-reason-container" style="display: none; margin-bottom: 20px;">
                    <label for="account-other-reason" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Please specify:
                    </label>
                    <textarea 
                        id="account-other-reason" 
                        class="form-input" 
                        rows="3" 
                        placeholder="Tell us more..."
                        style="width: 100%; resize: vertical;"
                    ></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeCancelModal()" class="btn btn-outline" style="flex: 1;">
                        Keep Order
                    </button>
                    <button onclick="confirmCancelOrder()" class="btn" style="flex: 1; background: #ef4444; color: white;">
                        Yes, Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Hometown Grocery Delivery | üìû <a href="tel:555-123-4567">555-123-4567</a></p>
        </div>
    </footer>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <!-- Error Tracking & UI Modules -->
    <script src="js/error-tracking.js"></script>
    <script src="js/ui-helpers.js"></script>

    <script src="main.js"></script>
    <script>
        // Require authentication
        if (!customerAuth.requireAuth()) {
            // Will redirect if not logged in
        }

        // Check email verification status and show banner
        function checkEmailVerification() {
            const isVerified = customerAuth.isEmailVerified();
            const banner = document.getElementById('verification-banner');
            
            if (!isVerified && banner) {
                banner.style.display = 'block';
                
                // Add resend verification handler
                const resendBtn = document.getElementById('resend-verification-btn');
                if (resendBtn) {
                    resendBtn.addEventListener('click', async () => {
                        try {
                            resendBtn.disabled = true;
                            resendBtn.textContent = 'Sending...';
                            
                            await customerAuth.resendVerification();
                            toast.success('Verification email sent! Please check your inbox.');
                            
                            resendBtn.textContent = 'Resend Email';
                            resendBtn.disabled = false;
                        } catch (error) {
                            toast.error('Failed to send verification email: ' + error.message);
                            resendBtn.textContent = 'Resend Email';
                            resendBtn.disabled = false;
                        }
                    });
                }
            } else if (banner) {
                banner.style.display = 'none';
            }
        }

        let customer = null;

        // Load customer data
        async function loadCustomerData() {
            try {
                customer = await customerAuth.getProfile();
                displayProfile(customer);
                loadOrders();
                checkEmailVerification();
                loadProfileForm(customer);
                loadNotificationPreferences(customer);
            } catch (error) {
                message.showError('Failed to load profile');
                console.error(error);
            }
        }

        // Display profile
        function displayProfile(customer) {
            document.getElementById('profile-name').textContent = customer.name;
            document.getElementById('profile-email').textContent = customer.email;
            document.getElementById('profile-phone').textContent = customer.phone;
            document.getElementById('profile-orders').textContent = customer.totalOrders || 0;
            document.getElementById('profile-spent').textContent = '$' + (customer.totalSpent || 0).toFixed(2);
            
            if (customer.createdAt) {
                const date = new Date(customer.createdAt);
                document.getElementById('profile-since').textContent = date.toLocaleDateString();
            }
        }

        // Load profile form in settings
        function loadProfileForm(customer) {
            const profileNameInput = document.getElementById('profile-name');
            const profileEmailInput = document.getElementById('profile-email');
            const profilePhoneInput = document.getElementById('profile-phone');
            
            // Check if we're in settings tab (inputs exist)
            if (profileNameInput && profileNameInput.tagName === 'INPUT') {
                profileNameInput.value = customer.name || '';
                profileEmailInput.value = customer.email || '';
                profilePhoneInput.value = customer.phone || '';
            }
        }

        // Load notification preferences
        function loadNotificationPreferences(customer) {
            const emailCheckbox = document.getElementById('email-notifications');
            const smsCheckbox = document.getElementById('sms-notifications');
            
            if (customer.preferences?.notifications) {
                emailCheckbox.checked = customer.preferences.notifications.email !== false;
                smsCheckbox.checked = customer.preferences.notifications.sms === true;
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const token = customerAuth.getToken();
                const response = await fetch(`${API_CONFIG.BASE_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    displayOrders(data.orders);
                } else {
                    document.getElementById('orders-container').innerHTML = '<p>No orders yet. <a href="shop.html">Start shopping!</a></p>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-container').innerHTML = '<p>Error loading orders.</p>';
            }
        }

        // Display orders
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            container.innerHTML = orders.map(order => {
                // Use pricing.total if available, fallback to totalAmount or total
                const total = order.pricing?.total || order.totalAmount || order.total || 0;
                
                // Check if order can be modified
                const modifiableStatuses = ['placed', 'confirmed', 'shopping'];
                const canModify = modifiableStatuses.includes(order.status) && !order.delivery?.pickedUpAt;
                
                return `
                <div class="order-card-large">
                    <div class="order-card-header">
                        <div>
                            <div class="order-number">Order #${order.orderId}</div>
                            <div class="order-date">${new Date(order.createdAt).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <span class="status-badge-large status-${order.status}">${order.status.replace('-', ' ')}</span>
                    </div>
                    <div class="order-card-body">
                        <div class="order-info-large">
                            <span class="info-item">üí∞ Total: <strong>$${total.toFixed(2)}</strong></span>
                            <span class="info-item">üì¶ Items: <strong>${order.items.length}</strong></span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <a href="${API_CONFIG.BASE_URL}/orders/${order._id}/receipt" target="_blank" class="btn-large btn-secondary">
                                üìÑ View Receipt
                            </a>
                            ${canModify ? `
                                <button onclick="openEditOrderModal('${order._id}')" class="btn-large" style="background: #f59e0b; color: white;">
                                    ‚úèÔ∏è Edit Order
                                </button>
                                <button onclick="openCancelModal('${order._id}')" class="btn-large" style="background: #ef4444; color: white;">
                                    ‚ùå Cancel Order
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // ============ USUAL ORDERS ============
        async function loadUsualOrders() {
            try {
                const phone = customer?.phone;
                if (!phone) {
                    document.getElementById('usual-orders-container').innerHTML = `
                        <div class="empty-state-large">
                            <div class="empty-icon">‚≠ê</div>
                            <p>No saved orders yet.</p>
                            <p class="empty-hint">Complete an order and save it for quick reordering!</p>
                        </div>
                    `;
                    return;
                }

                const response = await fetch(`${API_CONFIG.BASE_URL}/usual-orders?phone=${encodeURIComponent(phone)}`);
                const data = await response.json();
                
                // If no usual orders exist, create a default one with essential groceries
                if (data.success && (!data.usualOrders || data.usualOrders.length === 0)) {
                    await createDefaultUsualOrder(phone);
                    // Reload to show the newly created default order
                    const retryResponse = await fetch(`${API_CONFIG.BASE_URL}/usual-orders?phone=${encodeURIComponent(phone)}`);
                    const retryData = await retryResponse.json();
                    if (retryData.success && retryData.usualOrders && retryData.usualOrders.length > 0) {
                        displayUsualOrders(retryData.usualOrders);
                    }
                } else if (data.success && data.usualOrders && data.usualOrders.length > 0) {
                    displayUsualOrders(data.usualOrders);
                } else {
                    document.getElementById('usual-orders-container').innerHTML = `
                        <div class="empty-state-large">
                            <div class="empty-icon">‚≠ê</div>
                            <p>No saved orders yet.</p>
                            <p class="empty-hint">Complete an order and save it for quick reordering!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading usual orders:', error);
                document.getElementById('usual-orders-container').innerHTML = `
                    <div class="empty-state-large">
                        <div class="empty-icon">‚ùå</div>
                        <p>Error loading saved orders.</p>
                    </div>
                `;
            }
        }

        // Create default usual order with essential groceries
        async function createDefaultUsualOrder(phone) {
            try {
                // Get products to find IDs for essential items
                const productsResponse = await fetch(`${API_CONFIG.BASE_URL}/products`);
                const productsData = await productsResponse.json();
                
                if (!productsData.products) return;
                
                // Find essential grocery items - pick the 6 most important
                const essentialItems = [];
                const itemsToFind = [
                    { name: 'Milk', qty: 2 },
                    { name: 'Bread', qty: 1 },
                    { name: 'Large Eggs', qty: 1 },
                    { name: 'Bottled Water', qty: 1 },
                    { name: 'Chicken Breast', qty: 2 },
                    { name: 'Bananas', qty: 1 }
                ];
                
                for (const item of itemsToFind) {
                    const product = productsData.products.find(p => 
                        p.name.includes(item.name) && p.status === 'active'
                    );
                    if (product) {
                        essentialItems.push({
                            productId: product._id,
                            quantity: item.qty
                        });
                    }
                    if (essentialItems.length >= 6) break;
                }
                
                // If we found at least 3 items, create the default order
                if (essentialItems.length >= 3) {
                    await fetch(`${API_CONFIG.BASE_URL}/usual-orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'üõí Essential Groceries',
                            phone: phone,
                            items: essentialItems
                        })
                    });
                }
            } catch (error) {
                console.error('Error creating default usual order:', error);
            }
        }

        // Display usual orders
        function displayUsualOrders(usualOrders) {
            const container = document.getElementById('usual-orders-container');
            container.innerHTML = usualOrders.map(order => {
                const itemCount = order.items.length;
                const lastUsed = order.lastUsed 
                    ? new Date(order.lastUsed).toLocaleDateString() 
                    : 'Never';
                
                return `
                <div class="order-card-large">
                    <div class="order-card-header">
                        <div>
                            <div class="order-number">‚≠ê ${order.name}</div>
                            <div class="order-date">${itemCount} items ‚Ä¢ Last used: ${lastUsed}</div>
                        </div>
                    </div>
                    <div class="order-card-body">
                        <div class="order-info-large">
                            <div class="usual-order-items">
                                ${order.items.slice(0, 3).map(item => 
                                    `<span class="item-tag">${item.quantity}x ${item.productId?.name || 'Item'}</span>`
                                ).join('')}
                                ${itemCount > 3 ? `<span class="item-tag">+${itemCount - 3} more</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="reorderUsualOrder('${order._id}')" class="btn-large btn-primary">
                                üõí Reorder Now
                            </button>
                            <button onclick="editUsualOrder('${order._id}')" class="btn-large btn-secondary">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteUsualOrder('${order._id}')" class="btn-large" style="background: #ef4444; color: white;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Reorder usual order
        async function reorderUsualOrder(usualOrderId) {
            try {
                loading.showOverlay('Adding items to cart...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/usual-orders/${usualOrderId}/reorder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to reorder');
                }
                
                // Add items to cart
                const cartItems = data.cartItems;
                let cart = JSON.parse(localStorage.getItem('hometownCart') || '[]');
                
                cartItems.forEach(newItem => {
                    const existingItem = cart.find(item => item.id === newItem.id);
                    if (existingItem) {
                        existingItem.quantity += newItem.quantity;
                    } else {
                        cart.push(newItem);
                    }
                });
                
                localStorage.setItem('hometownCart', JSON.stringify(cart));
                
                loading.hideOverlay();
                toast.success(`${cartItems.length} items added to cart!`);
                
                // Redirect to cart
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1000);
                
            } catch (error) {
                console.error('Reorder error:', error);
                loading.hideOverlay();
                toast.error(error.message || 'Failed to reorder');
            }
        }

        // Show create usual order modal
        async function showCreateUsualOrder() {
            try {
                loading.showOverlay('Loading products...');
                
                // Get all products
                const response = await fetch(`${API_CONFIG.BASE_URL}/products`);
                const data = await response.json();
                
                if (!data.products) {
                    throw new Error('Failed to load products');
                }
                
                const activeProducts = data.products.filter(p => p.status === 'active');
                
                loading.hideOverlay();
                
                // Show modal with product selection
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2>Create Usual Order</h2>
                            <button class="btn-icon" onclick="closeModal(this)">‚úï</button>
                        </div>
                        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Order Name</label>
                                <input type="text" id="new-usual-order-name" 
                                       placeholder="e.g., Weekly Essentials" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            
                            <h3 style="margin-bottom: 15px;">Select Products</h3>
                            <div id="create-usual-products-list" style="display: flex; flex-direction: column; gap: 10px;">
                                ${activeProducts.map(product => `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                        <div style="flex: 1;">
                                            <span style="font-size: 20px; margin-right: 8px;">${product.emoji || 'üì¶'}</span>
                                            <strong>${product.name}</strong>
                                            <span style="color: #666; margin-left: 8px;">$${product.price.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="number" 
                                                   id="qty-${product._id}" 
                                                   min="0" 
                                                   max="99" 
                                                   value="0" 
                                                   style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal(this)" class="btn-large btn-outline">Cancel</button>
                            <button onclick="saveNewUsualOrder()" class="btn-large btn-primary">Create Order</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Trigger animation by adding active class after a brief delay
                setTimeout(() => modal.classList.add('active'), 10);
            } catch (error) {
                loading.hideOverlay();
                toast.error(error.message || 'Failed to load products');
            }
        }

        // Close modal with animation
        function closeModal(element) {
            const modal = element.closest('.modal-overlay');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Save new usual order
        async function saveNewUsualOrder() {
            try {
                const name = document.getElementById('new-usual-order-name').value.trim();
                
                if (!name) {
                    toast.error('Please enter a name for this order');
                    return;
                }
                
                // Collect selected products
                const items = [];
                const productsResponse = await fetch(`${API_CONFIG.BASE_URL}/products`);
                const productsData = await productsResponse.json();
                
                for (const product of productsData.products) {
                    const qtyInput = document.getElementById(`qty-${product._id}`);
                    if (qtyInput) {
                        const qty = parseInt(qtyInput.value) || 0;
                        if (qty > 0) {
                            items.push({
                                productId: product._id,
                                quantity: qty
                            });
                        }
                    }
                }
                
                if (items.length === 0) {
                    toast.error('Please select at least one product');
                    return;
                }
                
                loading.showOverlay('Creating order...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/usual-orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        phone: customer?.phone,
                        items: items
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to create usual order');
                }
                
                loading.hideOverlay();
                toast.success('Usual order created successfully!');
                
                // Close modal with animation
                const modal = document.querySelector('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
                
                // Reload usual orders
                loadUsualOrders();
                
            } catch (error) {
                loading.hideOverlay();
                toast.error(error.message || 'Failed to create usual order');
            }
        }

        // Delete usual order
        async function deleteUsualOrder(usualOrderId) {
            if (!confirm('Are you sure you want to delete this saved order?')) {
                return;
            }
            
            try {
                loading.showOverlay('Deleting...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/usual-orders/${usualOrderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: customer?.phone
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to delete order');
                }
                
                loading.hideOverlay();
                toast.success('Saved order deleted successfully');
                loadUsualOrders(); // Reload the list
                
            } catch (error) {
                console.error('Delete error:', error);
                loading.hideOverlay();
                toast.error(error.message || 'Failed to delete order');
            }
        }

        // Edit usual order (redirect to cart with items)
        async function editUsualOrder(usualOrderId) {
            try {
                loading.showOverlay('Loading order...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/usual-orders/${usualOrderId}/reorder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to load order');
                }
                
                // Clear cart and add items
                const cartItems = data.cartItems;
                localStorage.setItem('hometownCart', JSON.stringify(cartItems));
                localStorage.setItem('editingUsualOrderId', usualOrderId);
                
                loading.hideOverlay();
                toast.success('Order loaded! Make your changes in the cart.');
                
                // Redirect to cart
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1000);
                
            } catch (error) {
                console.error('Edit error:', error);
                loading.hideOverlay();
                toast.error(error.message || 'Failed to load order');
            }
        }

        // ============ EDIT ORDER MODAL ============
        let currentEditOrder = null;
        let editOrderItems = [];
        let allProductsCache = []; // Cache products for easier access

        async function openEditOrderModal(orderId) {
            const modal = document.getElementById('edit-order-modal');
            modal.style.display = 'flex';
            document.getElementById('edit-order-loading').style.display = 'block';
            document.getElementById('edit-order-content').style.display = 'none';
            document.getElementById('edit-order-footer').style.display = 'none';

            try {
                const token = customerAuth.getToken();
                const response = await fetch(`${API_CONFIG.BASE_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!data.success || !data.order) {
                    throw new Error(data.message || 'Failed to load order');
                }

                currentEditOrder = data.order;
                editOrderItems = [...data.order.items]; // Clone items array

                // Load all products for selection
                const productsResponse = await fetch(`${API_CONFIG.BASE_URL}/products`);
                const productsData = await productsResponse.json();
                allProductsCache = productsData.products || [];

                displayEditOrderItems();
                updateEditOrderTotals();

                // Set notes
                document.getElementById('edit-notes').value = currentEditOrder.notes || '';

                document.getElementById('edit-order-loading').style.display = 'none';
                document.getElementById('edit-order-content').style.display = 'block';
                document.getElementById('edit-order-footer').style.display = 'flex';

            } catch (error) {
                console.error('Load order error:', error);
                toast.error(error.message || 'Failed to load order');
                closeEditOrderModal();
            }
        }

        function closeEditOrderModal() {
            document.getElementById('edit-order-modal').style.display = 'none';
            currentEditOrder = null;
            editOrderItems = [];
            allProductsCache = [];
        }

        function displayEditOrderItems() {
            const container = document.getElementById('edit-order-items');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Order Items</h3>
                    ${editOrderItems.map((item, index) => {
                        const product = item.productId || item;
                        return `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px;">
                                <span style="font-size: 2em;">${product.emoji || 'üì¶'}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 5px;">${product.name || item.name}</div>
                                    <div style="color: #6b7280;">$${(product.price || item.price).toFixed(2)} each</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: #f3f4f6; padding: 8px; border-radius: 8px;">
                                    <button onclick="updateEditItemQuantity(${index}, -1)" style="width: 36px; height: 36px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 18px; font-weight: bold;">‚àí</button>
                                    <input type="number" value="${item.quantity}" min="1" max="99" 
                                        onchange="setEditItemQuantity(${index}, this.value)"
                                        style="width: 60px; text-align: center; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; font-weight: 600;">
                                    <button onclick="updateEditItemQuantity(${index}, 1)" style="width: 36px; height: 36px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 18px; font-weight: bold;">+</button>
                                    <button onclick="removeEditItem(${index})" style="width: 36px; height: 36px; border: 1px solid #ef4444; color: #ef4444; background: white; border-radius: 4px; cursor: pointer; font-size: 18px;">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="toggleAddItemsSection()" class="btn-large" style="background: #10b981; color: white;">
                        ‚ûï Add More Items
                    </button>
                    <div id="add-items-section" style="display: none; margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;"></div>
                </div>
            `;
        }

        function updateEditItemQuantity(index, change) {
            if (editOrderItems[index]) {
                editOrderItems[index].quantity = Math.max(1, Math.min(99, editOrderItems[index].quantity + change));
                displayEditOrderItems();
                updateEditOrderTotals();
            }
        }

        function setEditItemQuantity(index, value) {
            const qty = parseInt(value) || 1;
            if (editOrderItems[index]) {
                editOrderItems[index].quantity = Math.max(1, Math.min(99, qty));
                updateEditOrderTotals();
            }
        }

        function removeEditItem(index) {
            if (editOrderItems.length <= 1) {
                toast.error('Order must have at least one item');
                return;
            }
            editOrderItems.splice(index, 1);
            displayEditOrderItems();
            updateEditOrderTotals();
        }

        function toggleAddItemsSection() {
            const section = document.getElementById('add-items-section');
            if (section.style.display === 'none') {
                // Show add items section
                section.style.display = 'block';
                displayAddItemsSection();
            } else {
                // Hide add items section
                section.style.display = 'none';
            }
        }

        function displayAddItemsSection() {
            const section = document.getElementById('add-items-section');
            
            // Filter out items already in order
            const existingProductIds = editOrderItems.map(item => 
                (item.productId?._id || item.productId)?.toString()
            );
            
            const availableProducts = allProductsCache.filter(product => 
                product.status === 'active' && !existingProductIds.includes(product._id.toString())
            );

            if (availableProducts.length === 0) {
                section.innerHTML = '<p style="color: #6b7280;">All available products are already in your order.</p>';
                return;
            }

            section.innerHTML = `
                <h4 style="margin-bottom: 15px;">Select Products to Add</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${availableProducts.map(product => `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px;">
                            <span style="font-size: 1.5em;">${product.emoji || 'üì¶'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${product.name}</div>
                                <div style="color: #6b7280; font-size: 0.9em;">$${product.price.toFixed(2)}</div>
                            </div>
                            <button onclick="addItemToOrder('${product._id}')" class="btn-large" style="background: #10b981; color: white; padding: 8px 16px; font-size: 14px;">
                                ‚ûï Add
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function addItemToOrder(productId) {
            const product = allProductsCache.find(p => p._id === productId);
            if (!product) {
                toast.error('Product not found');
                return;
            }

            // Add to order items
            editOrderItems.push({
                productId: product,
                name: product.name,
                price: product.price,
                emoji: product.emoji,
                quantity: 1
            });

            displayEditOrderItems();
            updateEditOrderTotals();
            toast.success(`${product.name} added!`);
        }

        function updateEditOrderTotals() {
            let subtotal = 0;
            editOrderItems.forEach(item => {
                const product = item.productId || item;
                const price = product.price || item.price || 0;
                subtotal += price * item.quantity;
            });

            const deliveryFee = currentEditOrder?.pricing?.deliveryFee || 6.99;
            const tip = currentEditOrder?.pricing?.tip || 0;
            const discount = currentEditOrder?.pricing?.discount || 0;
            
            // Calculate tax (8.6%)
            const taxRate = 0.086;
            const tax = subtotal * taxRate;
            
            const total = subtotal + deliveryFee + tip + tax - discount;

            document.getElementById('edit-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('edit-delivery-fee').textContent = `$${deliveryFee.toFixed(2)}`;
            document.getElementById('edit-tip').textContent = `$${tip.toFixed(2)}`;
            document.getElementById('edit-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('edit-total').textContent = `$${total.toFixed(2)}`;
        }

        async function saveOrderChanges() {
            if (editOrderItems.length === 0) {
                if (typeof toast !== 'undefined') {
                    toast.error('Order must have at least one item');
                } else {
                    alert('Order must have at least one item');
                }
                return;
            }

            try {
                if (typeof loading !== 'undefined') {
                    loading.showOverlay('Saving changes...');
                }

                const token = customerAuth.getToken();
                
                // Properly extract productId - handle both object and string formats
                const itemsPayload = editOrderItems.map(item => {
                    let productId;
                    
                    // If productId is an object with _id
                    if (item.productId && typeof item.productId === 'object' && item.productId._id) {
                        productId = item.productId._id;
                    } 
                    // If productId is already a string
                    else if (item.productId && typeof item.productId === 'string') {
                        productId = item.productId;
                    }
                    // Fallback - shouldn't happen but just in case
                    else {
                        console.error('Invalid item structure:', item);
                        productId = null;
                    }
                    
                    return {
                        productId: productId,
                        quantity: item.quantity
                    };
                });

                // Filter out any items with null productId
                const validItems = itemsPayload.filter(item => item.productId);
                
                if (validItems.length === 0) {
                    throw new Error('No valid items to save');
                }

                console.log('Sending items to API:', validItems); // Debug log

                const response = await fetch(`${API_CONFIG.BASE_URL}/orders/${currentEditOrder._id}/modify`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: validItems,
                        notes: document.getElementById('edit-notes').value
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to save changes');
                }

                if (typeof loading !== 'undefined') {
                    loading.hideOverlay();
                }
                
                if (typeof toast !== 'undefined') {
                    toast.success('Order updated successfully! üéâ');
                } else {
                    alert('Order updated successfully! üéâ');
                }
                
                closeEditOrderModal();
                loadOrders(); // Refresh order list

            } catch (error) {
                console.error('Save order error:', error);
                
                if (typeof loading !== 'undefined') {
                    loading.hideOverlay();
                }
                
                if (typeof toast !== 'undefined') {
                    toast.error(error.message || 'Failed to save changes');
                } else {
                    alert('Error: ' + (error.message || 'Failed to save changes'));
                }
            }
        }

        // ============ CANCEL ORDER MODAL ============
        let currentCancelOrderId = null;

        function openCancelModal(orderId) {
            console.log('Opening cancel modal for order:', orderId);
            currentCancelOrderId = orderId;
            const modal = document.getElementById('account-cancel-modal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.classList.add('active');
                console.log('Modal classes:', modal.className);
                document.body.style.overflow = 'hidden';
            } else {
                console.error('Cancel modal not found!');
            }
        }

        function closeCancelModal() {
            console.log('Closing cancel modal');
            const modal = document.getElementById('account-cancel-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                
                // Reset form
                const reasonSelect = document.getElementById('account-cancel-reason');
                const otherReason = document.getElementById('account-other-reason');
                const otherContainer = document.getElementById('account-other-reason-container');
                
                if (reasonSelect) reasonSelect.value = '';
                if (otherReason) otherReason.value = '';
                if (otherContainer) otherContainer.style.display = 'none';
            }
            currentCancelOrderId = null;
        }

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('account-cancel-modal');
                if (modal && modal.classList.contains('active')) {
                    closeCancelModal();
                }
            }
        });

        // Show/hide custom reason textarea
        document.addEventListener('DOMContentLoaded', function() {
            const cancelReasonSelect = document.getElementById('account-cancel-reason');
            if (cancelReasonSelect) {
                cancelReasonSelect.addEventListener('change', function() {
                    const otherContainer = document.getElementById('account-other-reason-container');
                    if (this.value === 'other') {
                        otherContainer.style.display = 'block';
                    } else {
                        otherContainer.style.display = 'none';
                    }
                });
            }
        });

        async function confirmCancelOrder() {
            const reasonSelect = document.getElementById('account-cancel-reason');
            const otherReasonInput = document.getElementById('account-other-reason');
            
            let reason = reasonSelect.value;
            
            if (!reason) {
                toast.error('Please select a cancellation reason');
                return;
            }
            
            if (reason === 'other') {
                const otherReason = otherReasonInput.value.trim();
                if (!otherReason) {
                    toast.error('Please specify your reason');
                    return;
                }
                reason = otherReason;
            }
            
            if (!currentCancelOrderId) {
                toast.error('Order information not found');
                return;
            }
            
            try {
                loading.showOverlay('Cancelling your order...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/orders/${currentCancelOrderId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('customerToken')}`
                    },
                    body: JSON.stringify({ 
                        reason, 
                        phone: customer?.phone 
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to cancel order');
                }
                
                // Close modal
                closeCancelModal();
                
                loading.hideOverlay();
                
                // Show success message
                toast.success('‚úÖ Order Cancelled Successfully - Refund will be processed within 5-7 business days');
                
                // Refresh order list
                setTimeout(() => {
                    loadOrders();
                }, 1500);
                
            } catch (error) {
                console.error('Cancel order error:', error);
                loading.hideOverlay();
                toast.error(error.message || 'Failed to cancel order. Please contact us directly.');
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.account-tab').forEach(t => t.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                // Load tab-specific data
                if (tab === 'usual-orders') {
                    loadUsualOrders();
                } else if (tab === 'addresses') {
                    loadAddresses();
                }
            });
        });

        // Address management
        function showAddAddress() {
            const addressesContainer = document.getElementById('addresses-container');
            addressesContainer.innerHTML = `
                <div class="address-form-large">
                    <h3 class="settings-heading">üìç Add New Address</h3>
                    <form id="add-address-form" class="form-large">
                        <div class="form-group-large">
                            <label>Address Label (e.g., Home, Work)</label>
                            <input type="text" id="address-label" required class="input-large" placeholder="Home">
                        </div>
                        <div class="form-group-large">
                            <label>Street Address</label>
                            <input type="text" id="address-street" required class="input-large" placeholder="123 Main Street">
                        </div>
                        <div class="form-group-large">
                            <label>City</label>
                            <input type="text" id="address-city" required class="input-large" placeholder="Your City">
                        </div>
                        <div class="form-group-large">
                            <label>State / Province</label>
                            <input type="text" id="address-state" required class="input-large" placeholder="State">
                        </div>
                        <div class="form-group-large">
                            <label>ZIP / Postal Code</label>
                            <input type="text" id="address-zip" required class="input-large" placeholder="12345">
                        </div>
                        <div class="form-group-large">
                            <label>Delivery Instructions (Optional)</label>
                            <textarea id="address-instructions" class="input-large" rows="3" placeholder="Leave at front door, ring doorbell, etc."></textarea>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button type="submit" class="btn-large btn-primary">üíæ Save Address</button>
                            <button type="button" class="btn-large btn-outline" onclick="loadAddresses()">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('add-address-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const addressData = {
                    label: document.getElementById('address-label').value,
                    street: document.getElementById('address-street').value,
                    city: document.getElementById('address-city').value,
                    state: document.getElementById('address-state').value,
                    zipCode: document.getElementById('address-zip').value,
                    instructions: document.getElementById('address-instructions').value
                };

                try {
                    loading.showOverlay('Saving address...');
                    
                    // Add address to customer's addresses array
                    if (!customer.addresses) customer.addresses = [];
                    customer.addresses.push(addressData);
                    
                    // Update customer profile
                    await customerAuth.updateProfile({ addresses: customer.addresses });
                    
                    loading.hideOverlay();
                    message.showSuccess('Address saved successfully!');
                    loadAddresses();
                } catch (error) {
                    loading.hideOverlay();
                    message.showError(error.message || 'Failed to save address');
                }
            });
        }

        function loadAddresses() {
            const addressesContainer = document.getElementById('addresses-container');
            
            if (!customer || !customer.addresses || customer.addresses.length === 0) {
                addressesContainer.innerHTML = `
                    <div class="empty-state-large">
                        <div class="empty-icon">üìç</div>
                        <p>No addresses saved yet.</p>
                        <p class="empty-hint">Add an address to make checkout faster!</p>
                    </div>
                `;
            } else {
                addressesContainer.innerHTML = `
                    <div class="addresses-grid">
                        ${customer.addresses.map((addr, index) => `
                            <div class="address-card-large">
                                <div class="address-card-header">
                                    <span class="address-label">${addr.label || 'Address'}</span>
                                    <button class="btn-icon" onclick="deleteAddress(${index})" title="Delete">üóëÔ∏è</button>
                                </div>
                                <div class="address-details">
                                    <p><strong>${addr.street}</strong></p>
                                    <p>${addr.city}, ${addr.state} ${addr.zipCode}</p>
                                    ${addr.instructions ? `<p class="address-instructions">üìù ${addr.instructions}</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        async function deleteAddress(index) {
            if (!confirm('Are you sure you want to delete this address?')) return;

            try {
                loading.showOverlay('Deleting address...');
                
                customer.addresses.splice(index, 1);
                await customerAuth.updateProfile({ addresses: customer.addresses });
                
                loading.hideOverlay();
                message.showSuccess('Address deleted successfully!');
                loadAddresses();
            } catch (error) {
                loading.hideOverlay();
                message.showError(error.message || 'Failed to delete address');
            }
        }

        // Update profile form
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            
            if (!name || !email || !phone) {
                message.showError('All fields are required');
                return;
            }
            
            try {
                loading.showOverlay('Updating profile...');
                const response = await api.put('/auth/profile', { name, email, phone });
                
                if (response.success) {
                    loading.hideOverlay();
                    message.showSuccess('Profile updated successfully');
                    // Reload customer data to update display
                    await loadCustomerData();
                } else {
                    throw new Error(response.message || 'Failed to update profile');
                }
            } catch (error) {
                loading.hideOverlay();
                message.showError(error.message || 'Failed to update profile');
            }
        });

        // Save notification preferences
        async function saveNotificationPreferences() {
            try {
                const emailNotifications = document.getElementById('email-notifications').checked;
                const smsNotifications = document.getElementById('sms-notifications').checked;
                
                loading.showOverlay('Saving preferences...');
                const response = await api.put('/auth/preferences', {
                    emailNotifications,
                    smsNotifications
                });
                
                if (response.success) {
                    loading.hideOverlay();
                    message.showSuccess('Preferences saved successfully');
                } else {
                    throw new Error(response.message || 'Failed to save preferences');
                }
            } catch (error) {
                loading.hideOverlay();
                message.showError(error.message || 'Failed to save preferences');
            }
        }

        // Change password
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                message.showError('New passwords do not match');
                return;
            }
            
            try {
                loading.showOverlay('Changing password...');
                await customerAuth.changePassword(currentPassword, newPassword);
                loading.hideOverlay();
                message.showSuccess('Password changed successfully');
                document.getElementById('change-password-form').reset();
            } catch (error) {
                loading.hideOverlay();
                message.showError(error.message);
            }
        });

        // Load data on page load
        loadCustomerData();
    </script>

    <style>
        /* Senior-Friendly Account Page Design */
        .account-page {
            padding: 30px 0 60px;
            min-height: calc(100vh - 200px);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .page-header-large {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header-large h1 {
            font-size: 42px;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .page-header-large .subtitle {
            font-size: 20px;
            color: #4a5568;
        }

        /* Email Verification Banner */
        .verification-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 3px solid #d97706;
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .verification-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .verification-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .verification-message {
            flex: 1;
            min-width: 250px;
        }

        .verification-message strong {
            display: block;
            font-size: 20px;
            color: #78350f;
            margin-bottom: 5px;
        }

        .verification-message p {
            font-size: 16px;
            color: #92400e;
            margin: 0;
            line-height: 1.5;
        }

        .btn-secondary-small {
            background: white;
            color: #d97706;
            border: 2px solid #d97706;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-secondary-small:hover {
            background: #d97706;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }

        .btn-secondary-small:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Large Tab Buttons */
        .tab-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .tab-btn {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
        }

        .tab-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        .tab-icon {
            font-size: 36px;
        }

        .tab-text {
            font-size: 18px;
        }

        /* Content Area */
        .account-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 32px;
            margin-bottom: 30px;
            color: #2d3748;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .account-tab {
            display: none;
        }

        .account-tab.active {
            display: block;
        }

        /* Profile Info Cards */
        .profile-info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }

        .info-icon {
            font-size: 48px;
            min-width: 60px;
            text-align: center;
        }

        .info-details {
            flex: 1;
        }

        .info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 22px;
            font-weight: 700;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .stat-number {
            font-size: 48px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 18px;
            color: #4a5568;
            font-weight: 600;
        }

        /* Order Cards */
        .order-card-large {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .order-card-large:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .order-number {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .order-date {
            font-size: 16px;
            color: #718096;
            margin-top: 5px;
        }

        .status-badge-large {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
            text-transform: capitalize;
        }

        .status-pending { background: #fed7d7; color: #c53030; }
        .status-confirmed { background: #bee3f8; color: #2c5282; }
        .status-preparing { background: #fefcbf; color: #744210; }
        .status-out-for-delivery { background: #c6f6d5; color: #22543d; }
        .status-delivered { background: #9ae6b4; color: #22543d; }

        .order-card-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .order-info-large {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .info-item {
            font-size: 18px;
            color: #4a5568;
        }

        /* Usual Order Items */
        .usual-order-items {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .item-tag {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #6366f1;
        }

        .page-subtitle {
            text-align: center;
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* Large Buttons */
        .btn-large {
            padding: 18px 35px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            border: 3px solid #667eea;
            color: #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .btn-outline {
            background: white;
            border: 3px solid #e53e3e;
            color: #e53e3e;
        }

        .btn-outline:hover {
            background: #e53e3e;
            color: white;
        }

        /* Forms */
        .form-large {
            max-width: 600px;
        }

        .form-group-large {
            margin-bottom: 25px;
        }

        .form-group-large label {
            display: block;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .input-large {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            transition: border-color 0.3s;
        }

        .input-large:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-hint {
            display: block;
            margin-top: 8px;
            font-size: 16px;
            color: #718096;
        }

        /* Settings */
        .settings-section-large {
            background: #f7fafc;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .settings-heading {
            font-size: 24px;
            margin-bottom: 25px;
            color: #2d3748;
        }

        .checkbox-label-large {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: 600;
        }

        .checkbox-label-large:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .checkbox-large {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .logout-section {
            text-align: center;
            padding-top: 30px;
            border-top: 3px solid #e2e8f0;
        }

        /* Empty States */
        .empty-state-large {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .empty-state-large p {
            font-size: 20px;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .empty-hint {
            font-size: 18px;
            color: #718096;
        }

        .loading-text-large {
            text-align: center;
            font-size: 24px;
            padding: 60px;
            color: #4a5568;
        }

        /* Address Management */
        .addresses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .address-card-large {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .address-card-large:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .address-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .address-label {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .btn-icon:hover {
            transform: scale(1.2);
        }

        .address-details {
            font-size: 18px;
            color: #4a5568;
            line-height: 1.6;
        }

        .address-details p {
            margin: 8px 0;
        }

        .address-instructions {
            font-size: 16px;
            color: #718096;
            font-style: italic;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }

        .address-form-large {
            background: #f7fafc;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        textarea.input-large {
            resize: vertical;
            font-family: inherit;
        }

        /* Edit Order Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 700px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 28px;
            color: #1f2937;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px 30px;
            border-top: 2px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 15px 15px;
        }

        .close {
            font-size: 36px;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .close:hover {
            color: #1f2937;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .page-header-large h1 {
                font-size: 32px;
            }

            .tab-buttons {
                grid-template-columns: 1fr 1fr;
            }

            .account-content {
                padding: 25px;
            }

            .section-title {
                font-size: 26px;
            }

            .profile-info-cards {
                grid-template-columns: 1fr;
            }

            .order-card-body {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <script src="back-to-top.js"></script>
</body>
</html>
