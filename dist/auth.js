const e={SESSION_KEY:"adminSession",ACTIVITIES_KEY:"adminActivities",REMEMBERED_USER_KEY:"rememberedUser",SESSION_DURATION:288e5,isLoggedIn:async function(){if(!api.getToken())return!1;try{const e=await api.verifyToken();return!(!e.success||!e.user)||(this.clearSession(),!1)}catch(e){return this.clearSession(),!1}},getSession:function(){try{const e=localStorage.getItem(this.SESSION_KEY);return e?JSON.parse(e):null}catch(e){return null}},getCurrentUser:function(){const e=this.getSession();return e?{username:e.username,name:e.name,role:e.role}:null},clearSession:function(){localStorage.removeItem(this.SESSION_KEY),api.clearToken()},logout:async function(){const e=this.getSession();e&&this.logActivity("logout",`${e.name||e.username} logged out`);try{await api.logout()}catch(e){}this.clearSession(),window.location.replace("admin-login.html")},extendSession:function(){const e=this.getSession();e&&(e.expiresAt=Date.now()+this.SESSION_DURATION,localStorage.setItem(this.SESSION_KEY,JSON.stringify(e)))},hasRole:function(e){const t=this.getSession();if(!t)return!1;const n={admin:3,manager:2,driver:1};return(n[t.role]||0)>=(n[e]||0)},requireLogin:async function(){return!!await this.isLoggedIn()||(sessionStorage.setItem("redirectAfterLogin",window.location.href),window.location.replace("admin-login.html"),!1)},requireRole:async function(e){return!(!await this.requireLogin()||!this.hasRole(e)&&(alert("You do not have permission to access this page."),window.location.replace("admin.html"),1))},logActivity:function(e,t){try{const n=JSON.parse(localStorage.getItem(this.ACTIVITIES_KEY)||"[]"),i=this.getSession();n.unshift({type:e,message:t,user:i?.username||"unknown",timestamp:Date.now()}),n.length>100&&(n.length=100),localStorage.setItem(this.ACTIVITIES_KEY,JSON.stringify(n))}catch(e){}},getActivities:function(e=50){try{return JSON.parse(localStorage.getItem(this.ACTIVITIES_KEY)||"[]").slice(0,e)}catch(e){return[]}},updateUserUI:function(){const e=this.getCurrentUser();e&&(document.querySelectorAll(".user-name").forEach(t=>{t.textContent=e.name||e.username}),document.querySelectorAll(".user-role").forEach(t=>{t.textContent=e.role}),document.querySelectorAll(".user-avatar-initials").forEach(t=>{t.textContent=this.getInitials(e.name||e.username)}))},getInitials:function(e){return e?e.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"??"}};function t(){confirm("Are you sure you want to logout?")&&e.logout()}document.addEventListener("DOMContentLoaded",async function(){const t=window.location.pathname;if(t.includes("admin-login"))return;if(!t.includes("admin"))return;if(!await e.requireLogin())return;let n;e.updateUserUI();const i=()=>{clearTimeout(n),n=setTimeout(()=>{e.extendSession()},1e3)};document.addEventListener("click",i),document.addEventListener("keypress",i),document.addEventListener("scroll",i),setInterval(async()=>{await e.isLoggedIn()||(alert("Your session has expired. Please login again."),e.logout())},6e4)});