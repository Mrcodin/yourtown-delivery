let e=[],t=[],n=[],i=[],a={},o=null;async function r(){try{window.socketManager&&(o=socketManager.connect(),socketManager.joinAdmin(),socketManager.on("new-order",e=>{Qe("New Order",`Order ${e.orderId} placed`),n.unshift(e),m()}),socketManager.on("order-updated",e=>{const t=n.findIndex(t=>t._id===e._id);-1!==t&&(n[t]=e),m()}),socketManager.on("driver-status-changed",t=>{const n=e.find(e=>e._id===t.driverId);n&&(n.status=t.status,m())}))}catch(e){}}async function s(){loading.showOverlay("Loading dashboard data...");try{const[a,o,r,s]=await Promise.all([api.getOrders({showLoading:!1}),api.getDrivers({showLoading:!1}),api.getCustomers({showLoading:!1}),api.getProducts({showLoading:!1})]);a.success?n=a.orders||[]:message.showWarning("Failed to load orders data.","Data Loading"),o.success?e=o.drivers||[]:message.showWarning("Failed to load drivers data.","Data Loading"),r.success?t=r.customers||[]:message.showWarning("Failed to load customers data.","Data Loading"),s.success?i=s.products||[]:message.showWarning("Failed to load products data.","Data Loading")}catch(e){message.showError(message.getUserFriendlyError(e),"Failed to Load Data")}finally{loading.hideOverlay()}}document.addEventListener("DOMContentLoaded",async function(){r(),await s(),l(),u(),setInterval(v,6e4)});const d=[{id:1,firstName:"Mary",lastName:"Johnson",phone:"555-111-2222",email:"mary@email.com",vehicle:"Blue Honda Civic",vehicleType:"car",licensePlate:"ABC-1234",status:"online",rating:4.9,totalDeliveries:156,earnings:624,joinDate:"2023-01-15"},{id:2,firstName:"Tom",lastName:"Rodriguez",phone:"555-333-4444",email:"tom@email.com",vehicle:"Red Toyota Camry",vehicleType:"car",licensePlate:"XYZ-5678",status:"busy",rating:4.8,totalDeliveries:98,earnings:392,joinDate:"2023-06-20"},{id:3,firstName:"Susan",lastName:"Williams",phone:"555-555-6666",email:"susan@email.com",vehicle:"White Ford Explorer",vehicleType:"suv",licensePlate:"DEF-9012",status:"offline",rating:5,totalDeliveries:234,earnings:936,joinDate:"2022-08-10"},{id:4,firstName:"James",lastName:"Brown",phone:"555-777-8888",email:"james@email.com",vehicle:"Black Chevy Malibu",vehicleType:"car",licensePlate:"GHI-3456",status:"online",rating:4.7,totalDeliveries:67,earnings:268,joinDate:"2024-01-05"}],c=[{id:1,name:"Margaret Roberts",phone:"555-100-1001",email:"margaret@email.com",address:"123 Oak Street, Apt 2B",totalOrders:24,totalSpent:487.5,lastOrder:"2024-01-15",notes:"Prefers morning deliveries"},{id:2,name:"Robert Thompson",phone:"555-100-1002",email:"robert@email.com",address:"456 Maple Avenue",totalOrders:18,totalSpent:342.25,lastOrder:"2024-01-14",notes:"Leave packages on porch"},{id:3,name:"Eleanor Baker",phone:"555-100-1003",email:"",address:"789 Pine Road",totalOrders:31,totalSpent:623.8,lastOrder:"2024-01-15",notes:"Ring doorbell twice"}];function l(){const e=window.location.pathname;e.includes("admin.html")||e.endsWith("/admin/")?y():e.includes("admin-orders.html")?F():e.includes("admin-products.html")?Q():e.includes("admin-drivers.html")?se():e.includes("admin-customers.html")?he():e.includes("admin-reports.html")&&Ee()}function u(){const e=document.getElementById("current-date");if(e){const t={weekday:"long",year:"numeric",month:"long",day:"numeric"};e.textContent=(new Date).toLocaleDateString("en-US",t)}}function m(){const e=window.location.pathname;e.includes("admin.html")||e.endsWith("/admin/")?(f(),w(),b(),$(),E()):e.includes("admin-orders.html")?O():e.includes("admin-drivers.html")?renderDriversTable():e.includes("admin-customers.html")?fe():e.includes("admin-products.html")&&(X(),ee())}async function v(){await s(),m()}function p(){}function g(){}function h(){const e=Date.now(),t=36e5;return[{id:"ORD-001234",name:"Margaret Roberts",phone:"555-100-1001",address:"123 Oak Street, Apt 2B",email:"margaret@email.com",items:[{id:1,name:"White Bread",price:2.99,quantity:2,emoji:"üçû"},{id:5,name:"Whole Milk",price:3.49,quantity:1,emoji:"ü•õ"},{id:7,name:"Large Eggs",price:3.29,quantity:1,emoji:"ü•ö"}],subtotal:12.76,delivery:6.99,total:"19.75",status:"placed",payment:"cash",deliveryTime:"asap",notes:"Ring doorbell twice",timestamp:e-18e5,driver:null,shopper:null},{id:"ORD-001233",name:"Robert Thompson",phone:"555-100-1002",address:"456 Maple Avenue",email:"robert@email.com",items:[{id:12,name:"Bananas",price:.69,quantity:3,emoji:"üçå"},{id:20,name:"Chicken Breast",price:5.99,quantity:2,emoji:"üçó"}],subtotal:14.05,delivery:6.99,total:"21.04",status:"confirmed",payment:"card",deliveryTime:"morning",notes:"",timestamp:e-1*t,driver:null,shopper:"Mary J."},{id:"ORD-001232",name:"Eleanor Baker",phone:"555-100-1003",address:"789 Pine Road",email:"",items:[{id:31,name:"Coffee",price:8.99,quantity:1,emoji:"‚òï"},{id:8,name:"Butter",price:4.99,quantity:1,emoji:"üßà"}],subtotal:13.98,delivery:6.99,total:"20.97",status:"shopping",payment:"cash",deliveryTime:"afternoon",notes:"Call when arriving",timestamp:e-2*t,driver:"Tom R.",shopper:"Tom R."},{id:"ORD-001231",name:"William Davis",phone:"555-100-1004",address:"321 Elm Street",email:"william@email.com",items:[{id:17,name:"Potatoes",price:4.99,quantity:1,emoji:"ü•î"},{id:21,name:"Ground Beef",price:6.99,quantity:2,emoji:"ü•©"}],subtotal:18.97,delivery:6.99,total:"25.96",status:"delivering",payment:"check",deliveryTime:"asap",notes:"",timestamp:e-3*t,driver:"Mary J.",shopper:"Mary J."},{id:"ORD-001230",name:"Patricia Wilson",phone:"555-100-1005",address:"654 Birch Lane",email:"patricia@email.com",items:[{id:34,name:"Ice Cream",price:4.99,quantity:2,emoji:"üç®"}],subtotal:9.98,delivery:6.99,total:"16.97",status:"delivered",payment:"cash",deliveryTime:"evening",notes:"",timestamp:e-5*t,driver:"Susan W.",shopper:"Susan W."}]}function y(){f(),w(),b(),$(),E(),R()}function f(){const t=(new Date).setHours(0,0,0,0),i=n.filter(e=>new Date(e.createdAt).setHours(0,0,0,0)===t),a=n.filter(e=>["placed","confirmed"].includes(e.status)),o=e.filter(e=>"available"===e.status||"busy"===e.status),r=i.reduce((e,t)=>e+(t.pricing?.total||t.total||0),0);Xe("stat-orders-today",i.length),Xe("stat-revenue-today","$"+r.toFixed(2)),Xe("stat-pending",a.length),Xe("stat-active-drivers",o.length)}function w(){const e=document.getElementById("recent-orders-list");if(!e)return;const t=n.slice(0,5);0!==t.length?e.innerHTML=t.map(e=>`\n        <div class="order-item" onclick="viewOrderDetail('${e._id}')">\n            <div class="order-id">${e.orderId}</div>\n            <div class="order-customer">\n                <div class="order-customer-name">${e.customerInfo?.name||e.customer?.name||"Unknown"}</div>\n                <div class="order-customer-address">${at(e.customerInfo?.address||e.customer?.address||"",30)}</div>\n            </div>\n            <div class="order-amount">$${(e.pricing?.total||e.total||0).toFixed(2)}</div>\n            <div class="order-status ${e.status}">${Ze(e.status)}</div>\n        </div>\n    `).join(""):e.innerHTML='<p class="empty-message">No orders yet</p>'}function b(){const e=document.getElementById("active-deliveries-list"),t=document.getElementById("active-deliveries-count");if(!e)return;const i=n.filter(e=>["in_progress","ready","out_for_delivery"].includes(e.status));t&&(t.textContent=i.length),0!==i.length?e.innerHTML=i.map(e=>`\n        <div class="order-item" onclick="viewOrderDetail('${e._id}')">\n            <div class="order-status ${e.status}">${Ze(e.status)}</div>\n            <div class="order-customer">\n                <div class="order-customer-name">${e.customerInfo?.name||e.customer?.name||"Unknown"}</div>\n                <div class="order-customer-address">Driver: ${e.delivery?.driverName||e.assignedDriver?.name||"Unassigned"}</div>\n            </div>\n            <div class="order-amount">$${(e.pricing?.total||e.total||0).toFixed(2)}</div>\n        </div>\n    `).join(""):e.innerHTML='<p class="empty-message">No active deliveries</p>'}function $(){const t=document.getElementById("drivers-status-grid");t&&(0!==e.length?t.innerHTML=e.map(e=>{const t=`${e.firstName} ${e.lastName}`;return`\n            <div class="driver-status-card">\n                <div class="driver-avatar">${I(t)}</div>\n                <div class="driver-info">\n                    <div class="driver-name">${t}</div>\n                    <div class="driver-status ${e.status}">\n                        <span class="status-dot"></span>\n                        ${it(e.status)}\n                    </div>\n                </div>\n            </div>\n        `}).join(""):t.innerHTML='<p class="empty-message">No drivers available</p>')}function I(e){return e?e.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"??"}function E(){const e=document.getElementById("activity-timeline");if(!e)return;const t=n.slice(0,6).map(e=>({time:Ke(e.createdAt),title:`Order ${e.orderId}`,description:`${e.customerInfo?.name||e.customer?.name||"Unknown"} - ${Ze(e.status)}`}));0!==t.length?e.innerHTML=t.map(e=>`\n        <div class="activity-item">\n            <div class="activity-time">${e.time}</div>\n            <div class="activity-dot"></div>\n            <div class="activity-content">\n                <div class="activity-title">${e.title}</div>\n                <div class="activity-description">${e.description}</div>\n            </div>\n        </div>\n    `).join(""):e.innerHTML='<p class="empty-message">No activity today</p>'}function v(){document.getElementById("recent-orders-list")&&(p(),y())}function D(){const e=document.getElementById("user-menu");e.classList.toggle("active"),e.classList.contains("active")&&setTimeout(()=>{document.addEventListener("click",x)},0)}function x(e){const t=document.getElementById("user-menu"),n=document.querySelector(".topbar-user");t.contains(e.target)||n.contains(e.target)||(t.classList.remove("active"),document.removeEventListener("click",x))}function B(){const e=Auth.getCurrentUser();alert(`üë§ Profile\n\nUsername: ${e.username}\nName: ${e.name}\nRole: ${e.role}`)}function L(){if(!prompt("Enter current password:"))return;const e=prompt("Enter new password (min 8 characters):");!e||e.length<8?alert("Password must be at least 8 characters"):e===prompt("Confirm new password:")?(alert("‚úÖ Password changed successfully!\n\n(Note: In demo mode, password is not actually changed)"),Auth.logActivity("password_change","Password changed")):alert("Passwords do not match")}function S(){const e=Auth.getActivities(20);let t='\n        <div style="max-height: 400px; overflow-y: auto;">\n            <table style="width: 100%; border-collapse: collapse;">\n                <thead>\n                    <tr style="background: #f8fafc;">\n                        <th style="padding: 10px; text-align: left;">Time</th>\n                        <th style="padding: 10px; text-align: left;">User</th>\n                        <th style="padding: 10px; text-align: left;">Activity</th>\n                    </tr>\n                </thead>\n                <tbody>\n    ';e.forEach(e=>{const n=new Date(e.timestamp).toLocaleString();t+=`\n            <tr style="border-bottom: 1px solid #e2e8f0;">\n                <td style="padding: 10px; font-size: 13px; color: #64748b;">${n}</td>\n                <td style="padding: 10px; font-size: 13px;">${e.user}</td>\n                <td style="padding: 10px; font-size: 13px;">${e.message}</td>\n            </tr>\n        `}),t+="</tbody></table></div>";const n=document.createElement("div");n.className="modal-overlay active",n.id="activity-log-modal",n.innerHTML=`\n        <div class="modal modal-large">\n            <div class="modal-header">\n                <h2>üìã Activity Log</h2>\n                <button class="modal-close" onclick="closeModal('activity-log-modal')">√ó</button>\n            </div>\n            <div class="modal-body">\n                ${e.length>0?t:'<p class="empty-message">No activity recorded yet.</p>'}\n            </div>\n            <div class="modal-footer">\n                <button class="btn btn-outline" onclick="clearActivityLog()">Clear Log</button>\n                <button class="btn btn-primary" onclick="closeModal('activity-log-modal')">Close</button>\n            </div>\n        </div>\n    `,document.body.appendChild(n)}function k(){confirm("Are you sure you want to clear all activity history?")&&(localStorage.removeItem("adminActivities"),Ye("activity-log-modal"),Ge("Activity log cleared","success"))}let T=!1;function A(){localStorage.getItem("authToken")}function j(e){const t=document.createElement("div");t.className="session-warning show",t.id="session-warning",t.innerHTML=`\n        <span>‚ö†Ô∏è Your session will expire in ${e} minutes</span>\n        <button onclick="extendSession()">Stay Logged In</button>\n        <button onclick="adminLogout()" style="background: #64748b;">Logout</button>\n    `,document.body.appendChild(t)}function M(){Auth.extendSession(),T=!1;const e=document.getElementById("session-warning");e&&e.remove(),Ge("Session extended","success")}function N(e,t="admin"){return Auth.hasRole(t)?(Auth.logActivity(e.name||"action",e.description||"Performed action"),!0):(Ge("You do not have permission for this action","error"),!1)}function F(){O(),H(),R(),G()}function O(){const e=document.getElementById("orders-table-body"),t=document.getElementById("orders-empty");if(!e)return;let n=C();if(0===n.length)return e.innerHTML="",void(t&&(t.style.display="block"));t&&(t.style.display="none"),e.innerHTML=n.map(e=>{const t=e.orderId||e.id,n=e.customerInfo?.name||e.customer?.name||e.name||"Unknown",i=e.customerInfo?.phone||e.customer?.phone||e.phone||"",a=e.items?.length||0,o=e.pricing?.total||e.total||0,r=e.delivery?.driverName||e.assignedDriver?.name||e.driver||"‚Äî",s=e.createdAt||e.timestamp,d=e._id||e.id;return`\n            <tr>\n                <td><strong>${t}</strong></td>\n                <td>\n                    <div>${n}</div>\n                    <small style="color: #64748b;">${i}</small>\n                </td>\n                <td>${a} items</td>\n                <td><strong>$${o.toFixed(2)}</strong></td>\n                <td><span class="order-status ${e.status}">${Ze(e.status)}</span></td>\n                <td>${r}</td>\n                <td>${Ke(s)}</td>\n                <td>\n                    <div class="table-actions">\n                        <button class="table-btn view" onclick="viewOrderDetail('${d}')">View</button>\n                        <button class="table-btn edit" onclick="quickUpdateStatus('${d}')">Update</button>\n                    </div>\n                </td>\n            </tr>\n        `}).join("")}function C(){let e=[...n];const t=document.getElementById("filter-status")?.value,i=document.getElementById("filter-date")?.value,a=document.getElementById("filter-search")?.value?.toLowerCase();if(t&&"all"!==t&&(e=e.filter(e=>e.status===t)),i&&"all"!==i){const t=new Date,n=new Date(t.setHours(0,0,0,0));e=e.filter(e=>{const t=new Date(e.createdAt||e.timestamp);switch(i){case"today":return t>=n;case"yesterday":const e=new Date(n);return e.setDate(e.getDate()-1),t>=e&&t<n;case"week":const i=new Date(n);return i.setDate(i.getDate()-7),t>=i;case"month":const a=new Date(n);return a.setMonth(a.getMonth()-1),t>=a;default:return!0}})}return a&&(e=e.filter(e=>(e.orderId||e.id||"").toLowerCase().includes(a)||(e.customerInfo?.name||e.name||"").toLowerCase().includes(a)||(e.customerInfo?.phone||e.phone||"").includes(a)||(e.customerInfo?.address||e.address||"").toLowerCase().includes(a))),e.sort((e,t)=>{const n=new Date(e.createdAt||e.timestamp||0).getTime();return new Date(t.createdAt||t.timestamp||0).getTime()-n}),e}function P(){O(),H()}function q(){const e=document.getElementById("filter-status"),t=document.getElementById("filter-date"),n=document.getElementById("filter-search");e&&(e.value="all"),t&&(t.value="all"),n&&(n.value=""),P()}function H(){const e=n.length,t=n.filter(e=>"placed"===e.status).length,i=n.filter(e=>["confirmed","shopping","delivering"].includes(e.status)).length,a=n.filter(e=>"delivered"===e.status).length;Xe("count-all",e),Xe("count-new",t),Xe("count-progress",i),Xe("count-delivered",a)}function R(){const e=n.filter(e=>["placed","confirmed"].includes(e.status)).length;document.querySelectorAll("#pending-orders-count").forEach(t=>{t.textContent=e,t.style.display=e>0?"inline":"none"})}setInterval(A,6e4);let U=null;function _(e){const t=n.find(t=>t._id===e||t.id===e);if(!t)return;U=t._id||e,Xe("modal-order-id",t.orderId||t.id),Xe("detail-name",t.customerInfo?.name||t.customer?.name||t.name||"‚Äî"),Xe("detail-address",t.customerInfo?.address||t.customer?.address||t.address||"‚Äî"),Xe("detail-email",t.customerInfo?.email||t.customer?.email||t.email||"‚Äî"),Xe("detail-time",tt(t.createdAt||t.timestamp)),Xe("detail-delivery-time",it(t.delivery?.timePreference||t.deliveryTime||"ASAP")),Xe("detail-payment",it(t.payment?.method||t.paymentMethod||t.payment||"cash")),Xe("detail-notes",t.notes||"‚Äî");const i=document.getElementById("detail-phone-link");if(i){const e=t.customerInfo?.phone||t.customer?.phone||t.phone||"";i.textContent=e,i.href="tel:"+e}const a=document.getElementById("detail-items");if(a){const e=t.items||[];a.innerHTML=e.map(e=>{const t=e.name||"Unknown Item",n=e.emoji||"üì¶",i=e.price||0,a=e.quantity||1;return`\n                <tr>\n                    <td>${n} ${t}</td>\n                    <td>$${i.toFixed(2)}</td>\n                    <td>${a}</td>\n                    <td>$${(i*a).toFixed(2)}</td>\n                </tr>\n            `}).join("")}const o=t.pricing?.subtotal||t.subtotal||t.pricing?.total-6.99||0,r=t.pricing?.total||t.total||0;Xe("detail-subtotal","$"+o.toFixed(2)),Xe("detail-total","$"+r.toFixed(2));const s=document.getElementById("update-status");s&&(s.value=t.status);const d=document.getElementById("assign-driver");d&&t.delivery?.driverId&&(d.value=t.delivery.driverId),We("order-detail-modal")}async function z(){if(!U)return;const e=n.find(e=>e._id===U||e.id===U);if(!e)return;const t=document.getElementById("update-status").value,i=document.getElementById("assign-driver"),a=i?.value;try{const n=await api.updateOrderStatus(e._id,t);if(!n.success)throw new Error(n.message||"Failed to update status");if(a&&""!==a&&"none"!==a&&a!==e.delivery?.driverId)try{(await api.assignDriver(e._id,a)).success||Ge("Status updated but driver assignment failed","warning")}catch(e){}Ge("Order updated successfully!","success"),Ye("order-detail-modal"),await s(),m(),R()}catch(e){Ge("Failed to update order: "+(e.message||"Unknown error"),"error")}}function W(e){_(e)}async function Y(){if(U&&confirm("Are you sure you want to cancel this order?"))try{const e=await api.updateOrderStatus(U,"cancelled");if(!e.success)throw new Error(e.message||"Failed to cancel order");Ge("Order cancelled","warning"),Ye("order-detail-modal"),await s(),m(),R()}catch(e){Ge("Failed to cancel order: "+(e.message||"Unknown error"),"error")}}function J(){window.print()}function V(){const e=n.find(e=>e._id===U);if(e){const t=e.customerInfo?.phone||e.phone;t&&(window.location.href="tel:"+t)}}function G(){const t=document.querySelectorAll("#assign-driver"),n=e.filter(e=>"inactive"!==e.status);t.forEach(e=>{e.innerHTML='<option value="">Assign Driver...</option>'+n.map(e=>`\n                <option value="${e.id}">${e.firstName} ${e.lastName} (${e.status})</option>\n            `).join("")})}function Q(){X(),ee()}function X(){const e=document.getElementById("products-grid");if(!e)return;let t=Z();0!==t.length?e.innerHTML=t.map(e=>`\n        <div class="product-admin-card">\n            <div class="product-admin-image">${e.emoji}</div>\n            <div class="product-admin-content">\n                <div class="product-admin-name">${e.name}</div>\n                <div class="product-admin-category">${it(e.category)}</div>\n                <div class="product-admin-price">$${e.price.toFixed(2)}</div>\n                <div class="product-admin-status ${e.status||"active"}">${oe(e.status||"active")}</div>\n                <div class="product-admin-actions">\n                    <button class="btn btn-outline btn-sm" onclick="editProduct('${e._id}')">‚úèÔ∏è Edit</button>\n                    <button class="btn btn-outline btn-sm" onclick="toggleProductStatus('${e._id}')">üëÅÔ∏è</button>\n                </div>\n            </div>\n        </div>\n    `).join(""):e.innerHTML='<div style="padding: 40px; text-align: center; color: #666;">No products found</div>'}function Z(){let e=[...i];const t=document.getElementById("filter-category")?.value,n=document.getElementById("filter-product-status")?.value,a=document.getElementById("filter-product-search")?.value?.toLowerCase();return t&&"all"!==t&&(e=e.filter(e=>e.category===t)),n&&"all"!==n&&(e=e.filter(e=>(e.status||"active")===n)),a&&(e=e.filter(e=>e.name.toLowerCase().includes(a)||e.category.toLowerCase().includes(a))),e}function K(){X()}function ee(){Xe("count-total-products",i.length),Xe("count-active-products",i.filter(e=>"active"===(e.status||"active")).length),Xe("count-out-of-stock",i.filter(e=>"out-of-stock"===e.status).length)}function te(){document.getElementById("product-modal-title").textContent="Add New Product",document.getElementById("product-form").reset(),document.getElementById("product-id").value="",We("product-modal")}function ne(e){const t=i.find(t=>t._id===e);t&&(document.getElementById("product-modal-title").textContent="Edit Product",document.getElementById("product-id").value=t._id,document.getElementById("product-name").value=t.name,document.getElementById("product-price").value=t.price,document.getElementById("product-category").value=t.category,document.getElementById("product-emoji").value=t.emoji,document.getElementById("product-status").value=t.status||"active",We("product-modal"))}async function ie(){const e=document.getElementById("product-id").value,t=document.getElementById("product-name").value,n=parseFloat(document.getElementById("product-price").value),a=document.getElementById("product-category").value,o=document.getElementById("product-emoji").value||"üì¶",r=document.getElementById("product-status").value;if(t&&n&&a)try{const s={name:t,price:n,category:a,emoji:o,status:r};if(e){const t=await api.updateProduct(e,s);if(!t.success)throw new Error(t.message||"Failed to update product");{const n=i.findIndex(t=>t._id===e);-1!==n&&(i[n]=t.product)}}else{const e=await api.createProduct(s);if(!e.success)throw new Error(e.message||"Failed to create product");i.push(e.product)}Ge("Product saved successfully!","success"),Ye("product-modal"),X(),ee()}catch(e){Ge("Failed to save product: "+e.message,"error")}else Ge("Please fill in all required fields","error")}async function ae(e){const t=i.find(t=>t._id===e);if(t)try{const n="active"===(t.status||"active")?"hidden":"active",i={name:t.name,price:t.price,category:t.category,emoji:t.emoji,status:n},a=await api.updateProduct(e,i);if(!a.success)throw new Error(a.message||"Failed to update product status");t.status=n,Ge("Product "+("active"===n?"shown":"hidden"),"success"),X(),ee()}catch(e){Ge("Failed to update product status: "+e.message,"error")}else Ge("Product not found","error")}function oe(e){return{active:"‚úÖ Active","out-of-stock":"‚ùå Out of Stock",hidden:"üëÅÔ∏è Hidden"}[e]||e}async function re(){try{const t=await api.getDrivers({showLoading:!1});t.success&&(e=t.drivers||[],de(),ce())}catch(e){}}function se(){de(),ce()}function de(){const t=document.getElementById("drivers-grid");t&&(0!==e.length?t.innerHTML=e.map(e=>{const t=`${e.firstName} ${e.lastName}`,n=I(t),i=e.totalDeliveries||0,a=e.rating||5,o=e.vehicle?.type||"car",r=e.vehicle?.description||it(o);return`\n            <div class="driver-card">\n                <div class="driver-card-header">\n                    <div class="driver-avatar-large">${n}</div>\n                    <div class="driver-card-info">\n                        <h3>${t}</h3>\n                        <span class="driver-status-badge ${e.status}">${it(e.status)}</span>\n                    </div>\n                </div>\n                \n                <div class="driver-card-stats">\n                    <div class="driver-stat">\n                        <div class="driver-stat-value">${i}</div>\n                        <div class="driver-stat-label">Deliveries</div>\n                    </div>\n                    <div class="driver-stat">\n                        <div class="driver-stat-value">${a.toFixed(1)}‚òÖ</div>\n                        <div class="driver-stat-label">Rating</div>\n                    </div>\n                    <div class="driver-stat">\n                        <div class="driver-stat-value">${r}</div>\n                        <div class="driver-stat-label">Vehicle</div>\n                    </div>\n                </div>\n                \n                <div class="driver-card-details">\n                    <div class="driver-detail-row">\n                        <span>Phone</span>\n                        <span>${e.phone}</span>\n                    </div>\n                    <div class="driver-detail-row">\n                        <span>Email</span>\n                        <span>${e.email||"N/A"}</span>\n                    </div>\n                </div>\n                \n                <div class="driver-card-actions">\n                    <button class="btn btn-outline btn-sm" onclick="viewDriverDetail('${e._id}')">View</button>\n                    <button class="btn btn-outline btn-sm" onclick="editDriver('${e._id}')">Edit</button>\n                    <button class="btn btn-outline btn-sm" onclick="callDriver('${e.phone}')">üìû</button>\n                </div>\n            </div>\n        `}).join(""):t.innerHTML='\n            <div class="admin-empty-state">\n                <div class="empty-icon">üöó</div>\n                <h3>No Drivers Yet</h3>\n                <p>Add drivers to start managing deliveries.</p>\n            </div>\n        ')}function ce(){const t=e.length,n=e.filter(e=>"available"===e.status).length,i=e.filter(e=>"busy"===e.status).length,a=e.filter(e=>"offline"===e.status).length;Xe("stat-total-drivers",t),Xe("stat-online-drivers",n),Xe("stat-busy-drivers",i),Xe("stat-offline-drivers",a)}function le(){document.getElementById("driver-modal-title").textContent="Add New Driver",document.getElementById("driver-form").reset(),document.getElementById("driver-id").value="",We("driver-modal")}function ue(t){const n=e.find(e=>e._id===t);n&&(document.getElementById("driver-modal-title").textContent="Edit Driver",document.getElementById("driver-id").value=n._id,document.getElementById("driver-first-name").value=n.firstName,document.getElementById("driver-last-name").value=n.lastName,document.getElementById("driver-phone").value=n.phone,document.getElementById("driver-email").value=n.email||"",document.getElementById("driver-vehicle-type").value=n.vehicle?.type||"car",document.getElementById("driver-vehicle").value=n.vehicle?.description||"",document.getElementById("driver-license").value=n.vehicle?.licensePlate||"",document.getElementById("driver-status").value=n.status,We("driver-modal"))}async function me(){const e=document.getElementById("driver-id").value,t=document.getElementById("driver-first-name").value.trim(),n=document.getElementById("driver-last-name").value.trim(),i=document.getElementById("driver-phone").value.trim(),a=document.getElementById("driver-email").value.trim(),o=document.getElementById("driver-vehicle-type").value,r=document.getElementById("driver-vehicle").value.trim(),s=document.getElementById("driver-license").value.trim(),d=document.getElementById("driver-status").value;if(!t||!n||!i)return void Ge("Please fill in all required fields","error");const c={firstName:t,lastName:n,phone:i,email:a,vehicle:{type:o,description:r,licensePlate:s},status:d};try{e?(await api.updateDriver(e,c),Ge("Driver updated successfully!","success")):(await api.createDriver(c),Ge("Driver created successfully!","success")),Ye("driver-modal"),await re()}catch(e){Ge("Failed to save driver: "+(e.message||"Unknown error"),"error")}}function ve(t){const i=e.find(e=>e._id===t);if(!i)return;const a=document.getElementById("driver-id");a&&(a.value=i._id),document.getElementById("driver-detail-avatar").textContent=`${i.firstName[0]}${i.lastName[0]}`,document.getElementById("driver-detail-name").textContent=`${i.firstName} ${i.lastName}`;const o=document.getElementById("driver-detail-status-badge");o.textContent=it(i.status),o.className=`driver-status-badge ${i.status}`;const r=i.vehicle?.description||it(i.vehicle?.type||"car");Xe("driver-total-deliveries",i.totalDeliveries),Xe("driver-rating",i.rating+"‚òÖ"),Xe("driver-earnings","$"+i.earnings),Xe("driver-detail-phone",i.phone),Xe("driver-detail-email",i.email||"‚Äî"),Xe("driver-detail-vehicle",r);const s=document.getElementById("driver-recent-deliveries"),d=`${i.firstName} ${i.lastName[0]}.`,c=n.filter(e=>e.driver===d).slice(0,3);s&&(0===c.length?s.innerHTML='<p class="empty-message">No recent deliveries</p>':s.innerHTML=c.map(e=>`\n                <div class="order-item" style="cursor: default;">\n                    <div class="order-id">${e.id}</div>\n                    <div class="order-customer">\n                        <div class="order-customer-name">${e.name}</div>\n                        <div class="order-customer-address">${Ke(e.timestamp)}</div>\n                    </div>\n                    <div class="order-amount">$${e.total}</div>\n                    <div class="order-status ${e.status}">${Ze(e.status)}</div>\n                </div>\n            `).join("")),We("driver-detail-modal")}function pe(e){e&&(window.location.href="tel:"+e)}async function ge(){const e=document.getElementById("driver-id")?.value;if(e){if(confirm("Are you sure you want to deactivate this driver?"))try{await api.updateDriverStatus(e,"inactive"),Ge("Driver deactivated","warning"),Ye("driver-detail-modal"),await re()}catch(e){Ge("Failed to deactivate driver","error")}}else Ge("No driver selected","error")}function he(){ye(),fe()}function ye(){const e=t.length,n=t.filter(e=>(e.totalOrders||0)>1).length,i=t.reduce((e,t)=>e+(t.totalSpent||0),0),a=t.reduce((e,t)=>e+(t.totalOrders||0),0),o=a>0?i/a:0,r=t.length>0?t.reduce((e,t)=>(t.totalSpent||0)>(e.totalSpent||0)?t:e,t[0]):null,s=r?(r.name||"Unknown").split(" ")[0]:"‚Äî";Xe("stat-total-customers",e),Xe("stat-repeat-customers",n),Xe("stat-avg-order-value","$"+o.toFixed(2)),Xe("stat-top-customer",s)}function fe(){const e=document.getElementById("customers-grid");e&&(0!==t.length?e.innerHTML=t.map(e=>{try{const t=e.totalOrders||0,i=e.totalSpent||0,a=e.addresses?.find(e=>e.isDefault)||e.addresses?.[0],o=a?.street||e.address||"‚Äî",r=n.filter(t=>t.customerInfo?.phone===e.phone||t.customerId?._id===e._id||t.customerId===e._id).sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),s=r[0]?.createdAt||e.createdAt;return`\n                <div class="customer-card">\n                    <div class="customer-header">\n                        <div class="customer-avatar">${I(e.name||"N/A")}</div>\n                        <div class="customer-info">\n                            <h3>${e.name||"Unknown"}</h3>\n                            <p>${e.phone||"N/A"}</p>\n                        </div>\n                    </div>\n                    \n                    <div class="customer-stats">\n                        <div class="customer-stat">\n                            <div class="customer-stat-value">${t}</div>\n                            <div class="customer-stat-label">Orders</div>\n                        </div>\n                        <div class="customer-stat">\n                            <div class="customer-stat-value">$${i.toFixed(2)}</div>\n                            <div class="customer-stat-label">Total Spent</div>\n                        </div>\n                    </div>\n                    \n                    <div class="driver-card-details">\n                        <div class="driver-detail-row">\n                            <span>Email</span>\n                            <span>${e.email||"‚Äî"}</span>\n                        </div>\n                        <div class="driver-detail-row">\n                            <span>Address</span>\n                            <span>${at(o,25)}</span>\n                        </div>\n                        <div class="driver-detail-row">\n                            <span>Last Order</span>\n                            <span>${et(s)}</span>\n                        </div>\n                    </div>\n                    \n                    <div class="driver-card-actions">\n                        <button class="btn btn-outline btn-sm" onclick="viewCustomerOrders('${e.phone}')">View Orders</button>\n                        <button class="btn btn-outline btn-sm" onclick="callCustomerDirect('${e.phone}')">üìû Call</button>\n                    </div>\n                </div>\n            `}catch(e){return""}}).join(""):e.innerHTML='\n            <div class="admin-empty-state">\n                <div class="empty-icon">üë•</div>\n                <h3>No Customers Yet</h3>\n                <p>Customers will appear here after their first order.</p>\n            </div>\n        ')}function we(){fe()}function be(){api.exportCustomers(),Ge("Exporting customers...","success")}function $e(e){window.location.href=`admin-orders.html?search=${encodeURIComponent(e)}`}function Ie(e){window.location.href="tel:"+e}function Ee(){De(),xe(),Be(),Le(),Se(),ke(),Te()}function De(){const e=new Date,t=e.getMonth(),i=e.getFullYear(),a=n.filter(e=>{const n=new Date(e.createdAt||e.timestamp);return n.getMonth()===t&&n.getFullYear()===i}),o=a.reduce((e,t)=>e+parseFloat(t.pricing?.total||t.total||0),0),r=a.length>0?o/a.length:0,s=a.filter(e=>"delivered"===e.status).length,d=a.length>0?s/a.length*100:0;Xe("report-month-orders",a.length),Xe("report-month-revenue","$"+o.toFixed(2)),Xe("report-avg-order","$"+r.toFixed(2)),Xe("report-delivery-rate",d.toFixed(1)+"%")}function xe(){const e=document.getElementById("sales-chart");if(!e)return;const t=[];for(let e=6;e>=0;e--){const i=new Date;i.setDate(i.getDate()-e),i.setHours(0,0,0,0);const a=new Date(i);a.setDate(a.getDate()+1);const o=n.filter(e=>{const t=new Date(e.createdAt||e.timestamp);return t>=i&&t<a}),r=o.reduce((e,t)=>e+parseFloat(t.pricing?.total||t.total||0),0);t.push({date:i.toLocaleDateString("en-US",{weekday:"short"}),orders:o.length,revenue:r})}const i=Math.max(...t.map(e=>e.revenue),1);e.innerHTML=`\n        <div class="simple-chart">\n            ${t.map(e=>`\n                <div class="chart-bar-container">\n                    <div class="chart-bar" style="height: ${e.revenue/i*150}px;">\n                        <span class="chart-value">$${e.revenue.toFixed(0)}</span>\n                    </div>\n                    <div class="chart-label">${e.date}</div>\n                </div>\n            `).join("")}\n        </div>\n    `}function Be(){const e=document.getElementById("top-products");if(!e)return;const t={};n.forEach(e=>{e.items&&Array.isArray(e.items)&&e.items.forEach(e=>{const n=e.name||"Unknown";t[n]||(t[n]={name:n,emoji:e.emoji||"üì¶",quantity:0,revenue:0}),t[n].quantity+=e.quantity||0,t[n].revenue+=(e.price||0)*(e.quantity||0)})});const i=Object.values(t).sort((e,t)=>t.quantity-e.quantity).slice(0,5);0!==i.length?e.innerHTML=`\n        <table class="data-table">\n            <thead>\n                <tr>\n                    <th>Product</th>\n                    <th>Qty Sold</th>\n                    <th>Revenue</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${i.map(e=>`\n                    <tr>\n                        <td>${e.emoji} ${e.name}</td>\n                        <td>${e.quantity}</td>\n                        <td>$${e.revenue.toFixed(2)}</td>\n                    </tr>\n                `).join("")}\n            </tbody>\n        </table>\n    `:e.innerHTML='<p class="empty-message">No sales data yet</p>'}function Le(){const t=document.getElementById("driver-performance");if(!t)return;const i=e.map(e=>{const t=`${e.firstName} ${e.lastName}`,i=`${e.firstName} ${e.lastName[0]}.`,a=n.filter(e=>e.delivery?.driverName===t||e.delivery?.driverName===i||e.driver===t||e.driver===i).filter(e=>"delivered"===e.status);return{name:t,deliveries:e.totalDeliveries||a.length,rating:e.rating||5,earnings:e.earnings||4*a.length}}).sort((e,t)=>t.deliveries-e.deliveries);t.innerHTML=`\n        <table class="data-table">\n            <thead>\n                <tr>\n                    <th>Driver</th>\n                    <th>Deliveries</th>\n                    <th>Rating</th>\n                    <th>Earnings</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${i.map(e=>`\n                    <tr>\n                        <td>${e.name}</td>\n                        <td>${e.deliveries}</td>\n                        <td>${e.rating}‚òÖ</td>\n                        <td>$${e.earnings.toFixed(2)}</td>\n                    </tr>\n                `).join("")}\n            </tbody>\n        </table>\n    `}function Se(){const e=document.getElementById("order-status-breakdown");if(!e)return;const t={placed:0,confirmed:0,shopping:0,delivering:0,delivered:0,cancelled:0};n.forEach(e=>{t.hasOwnProperty(e.status)&&t[e.status]++});const i=n.length||1;e.innerHTML=`\n        <div style="padding: 20px;">\n            ${Object.entries(t).map(([e,t])=>`\n                <div style="margin-bottom: 15px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                        <span>${Ze(e)}</span>\n                        <span>${t} (${(t/i*100).toFixed(0)}%)</span>\n                    </div>\n                    <div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">\n                        <div style="background: ${Ae(e)}; height: 100%; width: ${t/i*100}%;"></div>\n                    </div>\n                </div>\n            `).join("")}\n        </div>\n    `}function ke(){const e=document.getElementById("payment-methods");if(!e)return;const t={cash:0,card:0,check:0};n.forEach(e=>{const n=e.payment?.method||e.paymentMethod||"cash";t.hasOwnProperty(n)&&t[n]++});const i=n.length||1;e.innerHTML=`\n        <div style="padding: 20px; display: flex; justify-content: space-around; text-align: center;">\n            <div>\n                <div style="font-size: 40px;">üíµ</div>\n                <div style="font-size: 24px; font-weight: 700;">${t.cash}</div>\n                <div style="color: #64748b;">Cash</div>\n                <div style="font-size: 14px; color: #64748b;">${(t.cash/i*100).toFixed(0)}%</div>\n            </div>\n            <div>\n                <div style="font-size: 40px;">üí≥</div>\n                <div style="font-size: 24px; font-weight: 700;">${t.card}</div>\n                <div style="color: #64748b;">Card</div>\n                <div style="font-size: 14px; color: #64748b;">${(t.card/i*100).toFixed(0)}%</div>\n            </div>\n            <div>\n                <div style="font-size: 40px;">üìù</div>\n                <div style="font-size: 24px; font-weight: 700;">${t.check}</div>\n                <div style="color: #64748b;">Check</div>\n                <div style="font-size: 14px; color: #64748b;">${(t.check/i*100).toFixed(0)}%</div>\n            </div>\n        </div>\n    `}function Te(){const e=document.getElementById("peak-hours");if(!e)return;const t={};for(let e=8;e<=19;e++)t[e]=0;n.forEach(e=>{const n=e.createdAt||e.timestamp;if(!n)return;const i=new Date(n).getHours();t.hasOwnProperty(i)&&t[i]++});const i=Math.max(...Object.values(t),1);e.innerHTML=`\n        <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 150px; padding: 20px; gap: 5px;">\n            ${Object.entries(t).map(([e,t])=>`\n                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">\n                    <div style="\n                        width: 100%;\n                        max-width: 30px;\n                        height: ${t/i*100}px;\n                        background: ${t===i?"#f59e0b":"#3b82f6"};\n                        border-radius: 4px 4px 0 0;\n                        min-height: 5px;\n                    "></div>\n                    <div style="font-size: 11px; color: #64748b; margin-top: 5px;">${je(e)}</div>\n                </div>\n            `).join("")}\n        </div>\n    `}function Ae(e){return{placed:"#f59e0b",confirmed:"#3b82f6",shopping:"#8b5cf6",delivering:"#ec4899",delivered:"#16a34a",cancelled:"#dc2626"}[e]||"#64748b"}function je(e){const t=parseInt(e);return 12===t?"12p":t>12?t-12+"p":t+"a"}function Me(){Ne(document.getElementById("report-period")?.value||"month"),Ee()}function Ne(e){const t=new Date;let i;switch(e){case"week":i=new Date(t),i.setDate(i.getDate()-7);break;case"month":default:i=new Date(t.getFullYear(),t.getMonth(),1);break;case"quarter":const e=Math.floor(t.getMonth()/3);i=new Date(t.getFullYear(),3*e,1);break;case"year":i=new Date(t.getFullYear(),0,1)}return n.filter(e=>{const n=new Date(e.createdAt||e.timestamp);return n>=i&&n<=t})}function Fe(){const e=document.getElementById("report-period")?.value||"month",t=Ne(e);if(0===t.length)return void Ge("No data to export for selected period","warning");const n=Ce(t,e),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),o=URL.createObjectURL(i);a.setAttribute("href",o),a.setAttribute("download",`orders-report-${e}-${(new Date).toISOString().split("T")[0]}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),Ge(`Exported ${t.length} orders successfully!`,"success")}function Oe(){const e=document.getElementById("report-period").value,t=Ne(e);if(!t||0===t.length)return void Ge("No orders to export","error");Ge("Generating PDF report...","info");const n=api.baseURL.replace("/api","");fetch(`${n}/api/reports/pdf`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({orders:t,period:{week:"Last 7 Days",month:"This Month",quarter:"This Quarter",year:"This Year"}[e]||"Custom Period"})}).then(e=>{if(!e.ok)throw new Error("Failed to generate PDF");return e.blob()}).then(t=>{const n=window.URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`sales-report-${e}-${(new Date).toISOString().split("T")[0]}.pdf`,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(n),Ge("PDF report generated successfully!","success")}).catch(e=>{Ge("Failed to generate PDF report","error")})}function Ce(e,t){const n=e.map(e=>{const t=new Date(e.createdAt||e.timestamp),n=(e.items||[]).map(e=>`${e.quantity}x ${e.name} ($${e.price})`).join("; ");return[e.orderId||e._id,t.toLocaleDateString(),t.toLocaleTimeString(),e.customerInfo?.name||e.customer?.name||"",e.customerInfo?.phone||e.customer?.phone||"",e.customerInfo?.email||e.customer?.email||"",e.status||"",e.payment?.method||e.paymentMethod||"",`"${n}"`,e.pricing?.subtotal||0,e.pricing?.deliveryFee||e.deliveryFee||6.99,e.pricing?.tip||0,e.pricing?.tax||0,e.pricing?.discount||0,e.pricing?.total||e.total||0,`"${e.delivery?.instructions||e.notes||""}"`]}),i=e.reduce((e,t)=>e+(t.pricing?.total||t.total||0),0),a=e.length,o=a>0?i/a:0,r=e.reduce((e,t)=>e+(t.pricing?.tip||0),0),s={cash:0,card:0,check:0};e.forEach(e=>{const t=e.payment?.method||e.paymentMethod||"cash";s.hasOwnProperty(t)&&s[t]++});const d={};e.forEach(e=>{const t=e.status||"unknown";d[t]=(d[t]||0)+1});let c=["Order ID","Date","Time","Customer Name","Phone","Email","Status","Payment Method","Items","Subtotal","Delivery Fee","Tip","Tax","Discount","Total","Special Instructions"].join(",")+"\n";return c+=n.map(e=>e.join(",")).join("\n"),c+="\n\n",c+="SUMMARY STATISTICS\n",c+=`Period,${t}\n`,c+=`Export Date,${(new Date).toLocaleString()}\n`,c+=`Total Orders,${a}\n`,c+=`Total Revenue,$${i.toFixed(2)}\n`,c+=`Average Order Value,$${o.toFixed(2)}\n`,c+=`Total Tips,$${r.toFixed(2)}\n`,c+="\n",c+="PAYMENT METHODS\n",c+=`Cash,${s.cash}\n`,c+=`Card,${s.card}\n`,c+=`Check,${s.check}\n`,c+="\n",c+="ORDER STATUS\n",Object.entries(d).forEach(([e,t])=>{c+=`${e},${t}\n`}),c}function Pe(){Ge("Redirecting to shop to place order...","success"),setTimeout(()=>{window.open("/shop.html","_blank")},500)}function qe(){const e=document.querySelectorAll(".item-select"),t='<option value="">Select item...</option>'+groceries.map(e=>`\n            <option value="${e.id}" data-price="${e.price}">\n                ${e.emoji} ${e.name} - $${e.price.toFixed(2)}\n            </option>\n        `).join("");e.forEach(e=>{e.innerHTML=t,e.addEventListener("change",Ue)})}function He(){const e=document.getElementById("order-items-builder"),t=document.createElement("div");t.className="item-row",t.innerHTML=`\n        <select class="form-input item-select">\n            <option value="">Select item...</option>\n            ${groceries.map(e=>`\n                <option value="${e.id}" data-price="${e.price}">\n                    ${e.emoji} ${e.name} - $${e.price.toFixed(2)}\n                </option>\n            `).join("")}\n        </select>\n        <input type="number" class="form-input item-qty" value="1" min="1">\n        <button type="button" class="btn btn-danger btn-sm" onclick="removeItemRow(this)">√ó</button>\n    `,e.appendChild(t),t.querySelector(".item-select").addEventListener("change",Ue),t.querySelector(".item-qty").addEventListener("change",Ue)}function Re(e){const t=e.closest(".item-row");document.getElementById("order-items-builder").querySelectorAll(".item-row").length>1&&(t.remove(),Ue())}function Ue(){const e=document.querySelectorAll(".item-row");let t=0;e.forEach(e=>{const n=e.querySelector(".item-select"),i=e.querySelector(".item-qty");if(n.value){const e=n.options[n.selectedIndex],a=parseFloat(e.dataset.price)||0,o=parseInt(i.value)||1;t+=a*o}});const n=t+6.99;Xe("po-subtotal","$"+t.toFixed(2)),Xe("po-total","$"+n.toFixed(2))}function _e(){const e=document.getElementById("po-name").value.trim(),t=document.getElementById("po-phone").value.trim(),i=document.getElementById("po-address").value.trim(),a=document.getElementById("po-time").value,o=document.getElementById("po-payment").value,r=document.getElementById("po-notes").value.trim();if(!e||!t||!i)return void Ge("Please fill in customer name, phone, and address","error");const s=[];if(document.querySelectorAll(".item-row").forEach(e=>{const t=e.querySelector(".item-select"),n=e.querySelector(".item-qty");if(t.value){const e=groceries.find(e=>e.id===parseInt(t.value));e&&s.push({id:e.id,name:e.name,price:e.price,emoji:e.emoji,quantity:parseInt(n.value)||1})}}),0===s.length)return void Ge("Please add at least one item to the order","error");const d=s.reduce((e,t)=>e+t.price*t.quantity,0),c=d+6.99,l="ORD-"+Date.now().toString().slice(-6),u={id:l,name:e,phone:t,address:i,email:"",items:s,subtotal:d,delivery:6.99,total:c.toFixed(2),status:"confirmed",payment:o,deliveryTime:a,notes:r+" [Phone Order]",timestamp:Date.now(),driver:null,shopper:null};n.unshift(u),g(),Ge(`Order ${l} created successfully!`,"success"),Ye("new-order-modal"),document.getElementById("orders-table-body")&&(O(),H()),document.getElementById("recent-orders-list")&&y(),R()}function ze(){const e=C();if(0===e.length)return void Ge("No orders to export","warning");const t=[["Order ID","Customer","Phone","Address","Items","Total","Status","Driver","Date"],...e.map(e=>[e.orderId||e.id,e.customerInfo?.name||e.name||"",e.customerInfo?.phone||e.phone||"",`"${(e.customerInfo?.address||e.address||"").replace(/"/g,'""')}"`,(e.items?.length||0)+" items","$"+(e.pricing?.total||e.total||0).toFixed(2),e.status||"",e.delivery?.driverName||e.driver||"",tt(e.createdAt||e.timestamp)])].map(e=>e.join(",")).join("\n"),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(n),i.download=`orders_${nt(new Date)}.csv`,i.click(),Ge(`Exported ${e.length} orders`,"success")}function We(e){const t=document.getElementById(e);t&&(t.classList.add("active"),document.body.style.overflow="hidden")}function Ye(e){const t=document.getElementById(e);t&&(t.classList.remove("active"),document.body.style.overflow="")}function Je(){const e=document.getElementById("admin-sidebar"),t=document.querySelector(".sidebar-overlay");if(e.classList.toggle("active"),!t){const e=document.createElement("div");e.className="sidebar-overlay",e.onclick=Je,document.body.appendChild(e)}document.querySelector(".sidebar-overlay")?.classList.toggle("active")}function Ve(){if(confirm("Are you sure you want to logout?")){localStorage.removeItem("adminSession"),localStorage.removeItem("adminLoggedIn");const e=JSON.parse(localStorage.getItem("adminActivities")||"[]");e.unshift({type:"logout",message:"User logged out",user:"admin",timestamp:Date.now()}),localStorage.setItem("adminActivities",JSON.stringify(e)),window.location.href="admin-login.html"}}function Ge(e,t="success"){const n=document.querySelector(".admin-toast");n&&n.remove();const i=document.createElement("div");i.className=`admin-toast ${t}`,i.innerHTML=`\n        <span>${e}</span>\n        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>\n    `,document.body.appendChild(i),setTimeout(()=>i.classList.add("show"),10),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},4e3)}function Qe(e,t,n="info"){"Notification"in window&&"granted"===Notification.permission&&new Notification(e,{body:t,icon:"/favicon.ico"}),Ge(`${e}: ${t}`,n)}function Xe(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}function Ze(e){return{placed:"üÜï New",confirmed:"‚úÖ Confirmed",in_progress:"üõí In Progress",ready:"üì¶ Ready",out_for_delivery:"üöó Out for Delivery",delivered:"‚úîÔ∏è Delivered",cancelled:"‚ùå Cancelled",shopping:"üõí Shopping",delivering:"üöó Delivering"}[e]||it(e)}function Ke(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}function et(e){return e?new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"‚Äî"}function tt(e){return new Date(e).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function nt(e){return e.toISOString().split("T")[0]}function it(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}function at(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":""}function I(e){return e?e.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"??"}function ot(){const e=new URLSearchParams(window.location.search);return Object.fromEntries(e)}document.addEventListener("click",function(e){e.target.classList.contains("modal-overlay")&&(e.target.classList.remove("active"),document.body.style.overflow="")}),document.addEventListener("keydown",function(e){"Escape"===e.key&&(document.querySelectorAll(".modal-overlay.active").forEach(e=>{e.classList.remove("active")}),document.body.style.overflow="")}),window.location.pathname.includes("admin-orders.html")&&document.addEventListener("DOMContentLoaded",function(){const e=ot();if(e.search){const t=document.getElementById("filter-search");t&&(t.value=e.search,P())}});