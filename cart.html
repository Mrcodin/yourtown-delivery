<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart - Hometown Delivery</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="loading.css">
    <link rel="stylesheet" href="breadcrumb.css">
    <link rel="stylesheet" href="toast.css">
    <link rel="stylesheet" href="back-to-top.css">
    <link rel="stylesheet" href="card-hover.css">
    <link rel="stylesheet" href="form-validation.css">
    <link rel="stylesheet" href="mobile-touch.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <script src="toast.js"></script>
    <!-- ACCESSIBILITY TOOLBAR -->
    <div class="accessibility-bar">
        <div class="container accessibility-container">
            <span>Accessibility:</span>
            <button onclick="toggleLargeText()" id="text-size-btn" class="access-btn">üî§ Larger Text</button>
            <button onclick="toggleContrast()" id="contrast-btn" class="access-btn">üåì High Contrast</button>
            <button onclick="speakPage()" id="speak-btn" class="access-btn">üîä Read Aloud</button>
        </div>
    </div>

    <!-- PHONE BAR -->
    <div class="phone-bar">
        <div class="container">
            üìû <strong>Prefer to Call?</strong> 
            <a href="tel:555-123-4567">555-123-4567</a> | 
            Mon-Fri 8am-6pm, Sat 9am-3pm
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="container header-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">üõí</span>
                <span class="logo-text">Hometown Delivery</span>
            </a>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
            <nav class="nav" id="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="shop.html" class="nav-link">Shop Groceries</a>
                <a href="cart.html" class="nav-link active">
                    üõí Cart (<span id="cart-count">0</span>)
                </a>
                <a href="track.html" class="nav-link">Track Order</a>
                <a href="about.html" class="nav-link">About Us</a>
                <span id="customer-nav"></span>
            </nav>
        </div>
    </header>

    <!-- BREADCRUMB -->
    <div class="container">
        <div id="breadcrumb-container"></div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Your Shopping Cart</h1>

            <!-- CART LAYOUT -->
            <div class="cart-layout">
                <!-- CART ITEMS -->
                <div class="cart-items-container">
                    <div id="cart-items">
                        <!-- Items loaded by JavaScript -->
                    </div>
                    
                    <!-- EMPTY CART STATE -->
                    <div class="empty-cart" id="empty-cart">
                        <div class="empty-icon">üõí</div>
                        <h3>Your cart is empty</h3>
                        <p>Add some groceries to get started!</p>
                        <a href="shop.html" class="btn btn-primary btn-lg">Start Shopping</a>
                    </div>

                    <!-- CONTINUE SHOPPING -->
                    <div class="cart-actions" id="cart-actions" style="display: none;">
                        <a href="shop.html" class="btn btn-outline">‚Üê Continue Shopping</a>
                        <button onclick="clearCart()" class="btn btn-outline btn-danger">üóëÔ∏è Clear Cart</button>
                    </div>
                </div>

                <!-- ORDER SUMMARY -->
                <div class="order-summary" id="order-summary" style="display: none;">
                    <div class="summary-card">
                        <h2 class="summary-title">Order Summary</h2>
                        
                        <div class="summary-row">
                            <span>Items (<span id="summary-item-count">0</span>)</span>
                            <span>$<span id="summary-subtotal">0.00</span></span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>$<span id="summary-delivery">6.99</span></span>
                        </div>
                        
                        <!-- PROMO CODE SECTION -->
                        <div class="promo-code-section" style="margin: 15px 0; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <span style="font-size: 20px;">üè∑Ô∏è</span>
                                <strong style="color: #374151; font-size: 15px;">Have a Promo Code?</strong>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input 
                                    type="text" 
                                    id="promo-code-input" 
                                    class="form-input" 
                                    placeholder="Enter code (e.g., WELCOME10)"
                                    style="flex: 1; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;"
                                >
                                <button 
                                    type="button" 
                                    id="apply-promo-btn" 
                                    class="btn btn-secondary" 
                                    onclick="applyPromoCode()"
                                    style="padding: 10px 24px; white-space: nowrap; font-weight: 600;"
                                >
                                    Apply
                                </button>
                            </div>
                            <div id="promo-message" style="font-size: 14px; margin-top: 8px; font-weight: 500;"></div>
                        </div>
                        
                        <!-- DISCOUNT ROW (hidden by default) -->
                        <div id="discount-row" style="display: none;">
                            <!-- Discount Breakdown Box -->
                            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 3px solid #10b981; border-radius: 12px; padding: 16px; margin: 15px 0; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 24px;">üéâ</span>
                                        <span style="font-weight: 700; color: #047857; font-size: 18px;">
                                            Promo Code Applied!
                                        </span>
                                    </div>
                                    <button 
                                        type="button" 
                                        onclick="removePromoCode()" 
                                        style="background: white; border: 2px solid #ef4444; color: #dc2626; cursor: pointer; font-size: 13px; padding: 6px 12px; border-radius: 6px; font-weight: 600; transition: all 0.2s;"
                                        onmouseover="this.style.background='#fef2f2'"
                                        onmouseout="this.style.background='white'"
                                        title="Remove promo code"
                                    >Remove</button>
                                </div>
                                
                                <!-- Code and Percentage Display -->
                                <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #86efac;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #065f46; font-size: 14px; font-weight: 500;">Promo Code:</span>
                                        <span style="color: #047857; font-size: 16px; font-weight: 700; font-family: monospace; background: #f0fdf4; padding: 4px 12px; border-radius: 4px;" id="discount-code"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #065f46; font-size: 14px; font-weight: 500;">Discount:</span>
                                        <span id="discount-percentage" style="font-weight: 700; color: #047857; font-size: 20px; background: #f0fdf4; padding: 4px 16px; border-radius: 6px;"></span>
                                    </div>
                                </div>
                                
                                <!-- Total Savings -->
                                <div style="display: flex; justify-content: space-between; align-items: center; color: #047857; font-size: 20px; font-weight: 700; padding: 12px; background: white; border-radius: 8px; border: 2px dashed #10b981;">
                                    <span>üí∞ You Save:</span>
                                    <span style="color: #10b981; font-size: 24px;">-$<span id="summary-discount">0.00</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-row summary-total">
                            <span>Total</span>
                            <span>$<span id="summary-total">0.00</span></span>
                        </div>

                        <hr class="summary-divider">

                        <!-- DELIVERY INFO FORM -->
                        <h3 class="form-section-title">üìç Delivery Information</h3>
                        
                        <!-- Saved Addresses Selection (for logged-in customers) -->
                        <div id="saved-addresses-section" style="display: none; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="saved-address-select" class="form-label">Use a Saved Address</label>
                                <select id="saved-address-select" class="form-input form-select">
                                    <option value="">-- Enter new address --</option>
                                </select>
                            </div>
                        </div>
                        
                        <form id="checkout-form">
                            <div class="form-group">
                                <label for="name" class="form-label">Full Name *</label>
                                <input 
                                    type="text" 
                                    id="name" 
                                    class="form-input" 
                                    placeholder="John Smith"
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="phone" class="form-label">Phone Number *</label>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    class="form-input" 
                                    placeholder="555-123-4567"
                                    required
                                >
                                <small class="form-help">We'll call to confirm your order</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="address" class="form-label">Delivery Address *</label>
                                <textarea 
                                    id="address" 
                                    class="form-input form-textarea" 
                                    placeholder="123 Main St, Apt 4B"
                                    required
                                ></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="email" class="form-label">Email (optional)</label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    class="form-input" 
                                    placeholder="john@email.com"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="delivery-time" class="form-label">Preferred Delivery Time</label>
                                <select id="delivery-time" class="form-input form-select">
                                    <option value="asap">As Soon As Possible</option>
                                    <option value="morning">Morning (9am - 12pm)</option>
                                    <option value="afternoon">Afternoon (12pm - 4pm)</option>
                                    <option value="evening">Evening (4pm - 7pm)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="notes" class="form-label">Special Instructions</label>
                                <textarea 
                                    id="notes" 
                                    class="form-input form-textarea" 
                                    placeholder="Ring doorbell, leave on porch, etc."
                                ></textarea>
                            </div>

                            <h3 class="form-section-title">üí≥ Payment Method</h3>
                            
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="payment" value="cash" checked>
                                    <div class="payment-content">
                                        <span class="payment-icon">üíµ</span>
                                        <div>
                                            <strong>Cash on Delivery</strong>
                                            <small>Pay your driver when they arrive</small>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment" value="check">
                                    <div class="payment-content">
                                        <span class="payment-icon">üìù</span>
                                        <div>
                                            <strong>Check</strong>
                                            <small>Make payable to "Hometown Delivery"</small>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment" value="card">
                                    <div class="payment-content">
                                        <span class="payment-icon">üí≥</span>
                                        <div>
                                            <strong>Credit/Debit Card</strong>
                                            <small>Secure payment via Stripe</small>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Card Payment Details (shown when card is selected) -->
                            <div id="card-payment-section" class="card-payment-section" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Card Information *</label>
                                    <div id="card-element" class="stripe-card-element"></div>
                                    <div id="card-errors" class="card-error-message" role="alert"></div>
                                    <small class="form-help">
                                        üîí Secure payment processed by Stripe. Your card details are never stored.
                                    </small>
                                </div>

                                <div class="security-badges">
                                    <span class="security-badge">üîí SSL Encrypted</span>
                                    <span class="security-badge">‚úì PCI Compliant</span>
                                    <span class="security-badge">üí≥ All Cards Accepted</span>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-xl btn-block">
                                <span class="btn-text">üöö Place Order</span>
                            </button>
                            
                            <p class="form-note">
                                We'll call you within 30 minutes to confirm your order
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer footer-simple">
        <div class="container">
            <p>&copy; 2024 Hometown Grocery Delivery | üìû <a href="tel:555-123-4567">555-123-4567</a></p>
        </div>
    </footer>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="api.js"></script>
    <script src="customer-auth.js"></script>
    <script src="loading.js"></script>
    <script src="breadcrumb.js"></script>
    <script src="config.js"></script>
    <script src="checkout.js"></script>
    <script src="page-config.js"></script>
    <script src="main.js"></script>
    <script src="cart-checkout.js"></script>
    <script src="back-to-top.js"></script>
    <script>
        // Update navigation
        function updateCustomerNav() {
            const navSpan = document.getElementById('customer-nav');
            if (customerAuth.isLoggedIn()) {
                navSpan.innerHTML = '<a href="customer-account.html" class="nav-link">üë§ My Account</a>';
                loadSavedAddresses();
            } else {
                navSpan.innerHTML = '<a href="customer-login.html" class="nav-link">Login</a>';
            }
        }
        updateCustomerNav();

        // Load saved addresses for logged-in customers
        async function loadSavedAddresses() {
            try {
                const customer = await customerAuth.getProfile();
                
                if (customer && customer.addresses && customer.addresses.length > 0) {
                    const section = document.getElementById('saved-addresses-section');
                    const select = document.getElementById('saved-address-select');
                    
                    // Show the saved addresses section
                    section.style.display = 'block';
                    
                    // Pre-fill name fields with customer info
                    document.getElementById('name').value = customer.name;
                    document.getElementById('phone').value = customer.phone;
                    // Only pre-fill email if customer has one
                    if (customer.email) {
                        document.getElementById('email').value = customer.email;
                    }
                    
                    // Add addresses to dropdown
                    customer.addresses.forEach((addr, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${addr.label || 'Address'} - ${addr.street}, ${addr.city}`;
                        select.appendChild(option);
                    });
                    
                    // Handle address selection
                    select.addEventListener('change', (e) => {
                        const selectedIndex = e.target.value;
                        
                        if (selectedIndex === '') {
                            // Clear address field for new entry
                            document.getElementById('address').value = '';
                        } else {
                            const addr = customer.addresses[selectedIndex];
                            const fullAddress = `${addr.street}\n${addr.city}, ${addr.state} ${addr.zipCode}${addr.instructions ? '\n\nInstructions: ' + addr.instructions : ''}`;
                            document.getElementById('address').value = fullAddress;
                        }
                    });
                }
            } catch (error) {
                console.log('Not logged in or unable to load addresses');
            }
        }
    </script>

    <style>
        /* Stripe Elements Styles */
        .card-payment-section {
            margin-top: 25px;
            padding: 25px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .stripe-card-element {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            transition: border-color 0.2s;
            min-height: 48px;
        }

        .stripe-card-element:hover,
        .stripe-card-element:focus {
            border-color: #667eea;
        }

        .card-error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            padding: 10px;
            background: #fee2e2;
            border-radius: 6px;
            border-left: 4px solid #ef4444;
        }

        .security-badges {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .security-badge {
            font-size: 13px;
            color: #059669;
            background: #d1fae5;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .checkout-progress-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: #eff6ff;
            border-radius: 8px;
            border: 2px solid #3b82f6;
            color: #1e40af;
            font-size: 16px;
            font-weight: 500;
        }

        .progress-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #bfdbfe;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .card-payment-section {
                padding: 20px;
            }

            .security-badges {
                flex-direction: column;
            }

            .security-badge {
                text-align: center;
            }

            /* Promo code mobile styles */
            .promo-code-section {
                padding: 12px !important;
            }

            #promo-code-input {
                font-size: 14px !important;
                padding: 12px !important;
            }

            #apply-promo-btn {
                padding: 12px 16px !important;
                font-size: 14px !important;
                min-width: 80px;
            }

            /* Discount box mobile */
            #discount-row > div {
                padding: 12px !important;
            }

            #discount-row button {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }
        }
    </style>
</body>
</html>
