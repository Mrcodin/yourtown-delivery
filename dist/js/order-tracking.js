let e=null;async function t(){const e=document.getElementById("track-phone"),t=e?e.value.trim():"";if(!t)return void("undefined"!=typeof toast&&toast.error("Please enter your phone number"));const d=document.getElementById("order-status"),s=document.getElementById("no-order");"undefined"!=typeof loading&&loading.showOverlay("Finding your order...");try{const e=await fetch(`${API_CONFIG.BASE_URL}/orders/track/${encodeURIComponent(t)}`),a=await e.json();if(!e.ok||!a.success||!a.order)return d&&(d.style.display="none"),s?s.style.display="block":"undefined"!=typeof toast&&toast.info("No recent orders found for this phone number"),void("undefined"!=typeof loading&&loading.hideOverlay());const i=a.order;s&&(s.style.display="none"),d&&(d.style.display="block");const c=document.getElementById("order-id");c&&(c.textContent=i.orderId||i._id.substring(0,8),c.dataset.mongoId=i._id);const l=document.getElementById("order-date");l&&(l.textContent=new Date(i.createdAt).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit"}));const u=document.getElementById("order-total");if(u){const e=i.pricing?.total||i.totalAmount||i.total||0;u.textContent=e.toFixed(2)}const m=document.getElementById("placed-time");if(m&&(m.textContent=new Date(i.createdAt).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})),i.delivery&&i.delivery.driverId){const e=document.getElementById("driver-info");if(e){const t=i.delivery.driverId,n=`${t.firstName||""} ${t.lastName||""}`.trim()||"Your Driver",o=document.getElementById("driver-full-name");o&&(o.textContent=n);const r=document.getElementById("driver-vehicle");if(r&&(r.textContent=t.vehicle||"On the way"),i.delivery.pickedUpAt){e.style.display="block";const n=e.querySelector('a[href^="tel:"]');n&&t.phone&&(n.href=`tel:${t.phone}`)}}}r(i.status,i),n(i),o(i),"undefined"!=typeof loading&&loading.hideOverlay(),"undefined"!=typeof toast&&toast.success("Order found!")}catch(e){"undefined"!=typeof ErrorTracker&&ErrorTracker.captureError(e,{context:"Order Tracking",action:"trackOrder",phone:t}),"undefined"!=typeof loading&&loading.hideOverlay(),"undefined"!=typeof toast&&toast.error("Error tracking order. Please try again.")}}function n(e){const t=document.getElementById("cancel-order-section");t&&(["placed","confirmed"].includes(e.status)&&!e.delivery?.pickedUpAt?t.style.display="block":t.style.display="none")}function o(e){if(window.io)try{const n=io(API_CONFIG.SOCKET_URL||"http://localhost:3000");n.on("connect",()=>{n.emit("track-order",{phone:e.customerInfo?.phone})}),n.on("order-status-changed",n=>{n.orderId!==e.orderId&&n._id!==e._id||(r(n.status,n),"undefined"!=typeof toast&&toast.success(`Order status updated: ${d(n.status)}`),window.location.pathname.includes("track.html")&&setTimeout(()=>t(),1e3))}),n.on("driver-assigned",n=>{n.orderId!==e.orderId&&n._id!==e._id||("undefined"!=typeof toast&&toast.success("A driver has been assigned to your order!"),setTimeout(()=>t(),1e3))}),n.on("disconnect",()=>{})}catch(e){"undefined"!=typeof ErrorTracker&&ErrorTracker.captureError(e,{context:"Order Tracking",action:"connectOrderTracking"})}}function r(e,t){const n={placed:["status-confirmed"],confirmed:["status-confirmed"],shopping:["status-confirmed","status-shopping"],delivering:["status-confirmed","status-shopping","status-delivering"],delivered:["status-confirmed","status-shopping","status-delivering","status-delivered"],cancelled:[]}[e]||[];if(["status-confirmed","status-shopping","status-delivering","status-delivered"].forEach(e=>{const t=document.getElementById(e);if(t){t.classList.remove("completed");const n=t.querySelector(".timeline-marker"),o={"status-confirmed":"2","status-shopping":"3","status-delivering":"4","status-delivered":"5"};n&&(n.textContent=o[e]||"")}}),n.forEach(e=>{const t=document.getElementById(e);if(t){t.classList.add("completed");const e=t.querySelector(".timeline-marker");e&&(e.textContent="✓")}}),"delivered"===e){const e=document.getElementById("delivered-time");e&&(e.textContent="Just now!")}const o=document.getElementById("cancel-order-section");o&&(o.style.display="placed"===e||"confirmed"===e?"block":"none")}function d(e){return{placed:"Order Placed",confirmed:"Order Confirmed",shopping:"Shopping in Progress",delivering:"Out for Delivery",delivered:"Delivered",cancelled:"Cancelled"}[e]||e}function s(){const e=document.getElementById("cancel-modal");e&&(e.classList.add("active"),document.body.style.overflow="hidden")}function a(){const e=document.getElementById("cancel-modal");if(e){e.classList.remove("active"),document.body.style.overflow="";const t=document.getElementById("cancel-reason"),n=document.getElementById("other-reason"),o=document.getElementById("other-reason-container");t&&(t.value=""),n&&(n.value=""),o&&(o.style.display="none")}}async function i(){const e=document.getElementById("cancel-reason"),n=document.getElementById("other-reason"),o=document.getElementById("track-phone");if(!o)return void("undefined"!=typeof showToast&&showToast("Phone number not found","error"));const r=o.value.trim();let d=e?e.value:"";if(!d)return void("undefined"!=typeof showToast&&showToast("Please select a cancellation reason","error"));if("other"===d){const e=n?n.value.trim():"";if(!e)return void("undefined"!=typeof showToast&&showToast("Please specify your reason","error"));d=e}const s=document.getElementById("order-id");if(!s)return void("undefined"!=typeof showToast&&showToast("Order information not found","error"));const i=s.dataset.mongoId;if(i)try{"undefined"!=typeof loading&&loading.showOverlay("Cancelling your order...");const e=await fetch(`${API_CONFIG.BASE_URL}/orders/${i}/cancel`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:d,phone:r})}),n=await e.json();if(!e.ok||!n.success)throw new Error(n.message||"Failed to cancel order");const o=n.refund?"Your payment has been refunded and will appear in your account within 5-7 business days.":"No charges were made to your account.";a(),"undefined"!=typeof showToast&&showToast("✅ Order Cancelled Successfully","success");const s=document.querySelector(".status-badge");s&&(s.textContent="❌ CANCELLED",s.style.background="#dc2626",s.style.color="white");const c=document.querySelector('button[onclick="showCancelModal()"]');c&&(c.style.display="none");const l=document.querySelector(".order-info-card");if(l){const e=document.createElement("div");e.style.cssText="background: #fee2e2; border: 2px solid #dc2626; border-radius: 12px; padding: 20px; margin-top: 20px; text-align: center;",e.innerHTML=`\n                <h3 style="color: #dc2626; margin: 0 0 10px 0; font-size: 22px;">\n                    ✅ Your order has been cancelled\n                </h3>\n                <p style="font-size: 18px; margin: 0; color: #1f2937;">\n                    ${o}\n                </p>\n            `,l.appendChild(e)}setTimeout(()=>{t()},2e3)}catch(e){"undefined"!=typeof ErrorTracker&&ErrorTracker.captureError(e,{context:"Order Tracking",action:"confirmCancelOrder",orderId:i}),"undefined"!=typeof showToast&&showToast(e.message||"Failed to cancel order. Please contact us directly.","error")}finally{"undefined"!=typeof loading&&loading.hideOverlay()}else"undefined"!=typeof showToast&&showToast("Order ID not available","error")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("cancel-reason");e&&e.addEventListener("change",function(){const e=document.getElementById("other-reason-container");e&&("other"===this.value?e.style.display="block":e.style.display="none")})}),window.trackOrder=t,window.showCancelModal=s,window.closeCancelModal=a,window.confirmCancelOrder=i,window.updateStatusTimeline=r,window.formatStatus=d;