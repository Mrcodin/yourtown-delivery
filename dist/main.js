let e=[],t=[];async function n(){const n=document.getElementById("grocery-grid"),o=document.getElementById("empty-state");n&&loading.showSkeleton(n,"product",6);try{const r=await api.getProducts({showLoading:!1});r.success&&r.products?(e=r.products.map(e=>({id:e._id,name:e.name,price:e.price,category:e.category,emoji:e.emoji||"üì¶",imageUrl:e.imageUrl||null,isTaxable:e.isTaxable||!1})),t=e.slice(0,6).map(e=>e.id),n&&(0===e.length?(n.innerHTML="",o&&o.removeAttribute("style")):(o&&(o.style.display="none"),g()))):(n&&(n.innerHTML=""),message.showError("Unable to load products from the server. Please refresh the page to try again.","Failed to Load Products",n))}catch(e){n&&(n.innerHTML=""),message.showError(message.getUserFriendlyError(e),"Connection Error",n)}}function o(e){M(e,"error")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n();let r=[];function i(){const e=localStorage.getItem("hometownCart");e&&(r=JSON.parse(e)),a()}function c(){localStorage.setItem("hometownCart",JSON.stringify(r)),a()}function a(){const e=document.querySelectorAll("#cart-count"),t=r.reduce((e,t)=>e+t.quantity,0);e.forEach(e=>e.textContent=t),s(),document.getElementById("cart-items")&&I()}function s(){const e=document.getElementById("cart-preview");if(!e)return;const t=r.reduce((e,t)=>e+t.quantity,0),n=r.reduce((e,t)=>e+t.price*t.quantity,0);t>0?(e.classList.add("active"),document.getElementById("preview-count").textContent=t,document.getElementById("preview-total").textContent=n.toFixed(2)):e.classList.remove("active")}function d(t){const n=e.find(e=>e.id===t);if(!n)return;const o=r.find(e=>e.id===t);o?o.quantity+=1:r.push({id:n.id,name:n.name,price:n.price,emoji:n.emoji,imageUrl:n.imageUrl,quantity:1,isTaxable:n.isTaxable||!1}),c(),M(`‚úÖ ${n.name} added to cart!`,"success")}function l(e){r=r.filter(t=>t.id!==e),c()}function u(e,t){const n=r.find(t=>t.id===e);n&&(n.quantity+=t,n.quantity<=0?l(e):c())}function m(){confirm("Are you sure you want to clear your cart?")&&(r=[],c(),M("Cart cleared","success"))}function y(){t.forEach(t=>{const n=e.find(e=>e.id===t);n&&(r.find(e=>e.id===t)||r.push({id:n.id,name:n.name,price:n.price,emoji:n.emoji,quantity:1}))}),c(),M("‚úÖ Your usual order has been loaded!","success")}function g(t=e){const n=document.getElementById("grocery-grid"),o=document.getElementById("empty-state"),r=document.getElementById("results-count");if(n){if(0===t.length)return n.style.display="none",void(o&&(o.style.display="block"));n.style.display="grid",o&&(o.style.display="none"),r&&(r.textContent=`Showing ${t.length} item${1!==t.length?"s":""}`),n.innerHTML=t.map(e=>{const t=e.imageUrl?`<img src="${e.imageUrl}" alt="${e.name}" style="width: 100%; height: 100%; object-fit: cover;">`:e.emoji;return`\n        <div class="grocery-item" data-category="${e.category}">\n            <div class="item-image" onclick="openQuickView('${e.id}')" style="cursor: pointer;">${t}</div>\n            <div class="item-content">\n                <h3 class="item-name">${e.name}</h3>\n                <div class="item-price">$${e.price.toFixed(2)}</div>\n                <div style="display: flex; gap: 8px;">\n                    <button class="add-btn" onclick="addToCart('${e.id}')" style="flex: 1;">\n                        Add to Cart\n                    </button>\n                    <button class="btn btn-secondary" onclick="openQuickView('${e.id}')" style="padding: 12px; width: 44px;" title="Quick View">\n                        üëÅÔ∏è\n                    </button>\n                </div>\n            </div>\n        </div>\n        `}).join("")}}function p(t,n){document.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),n&&n.classList.add("active");let o=e;"all"!==t&&(o=e.filter(e=>e.category===t)),g(o)}function f(){const t=document.getElementById("search-input").value.toLowerCase().trim();g(t?e.filter(e=>e.name.toLowerCase().includes(t)||e.category.toLowerCase().includes(t)):e)}function v(){const t=document.getElementById("sort-select")?.value;if(!t)return;let n=[...e];switch(t){case"name-asc":n.sort((e,t)=>e.name.localeCompare(t.name));break;case"name-desc":n.sort((e,t)=>t.name.localeCompare(e.name));break;case"price-asc":n.sort((e,t)=>e.price-t.price);break;case"price-desc":n.sort((e,t)=>t.price-e.price)}h(n)}function h(t){const n=document.getElementById("search-input")?.value.toLowerCase().trim(),o=document.getElementById("price-filter")?.value||"all",r=(document.getElementById("in-stock-filter"),document.querySelector(".category-btn.active")?.textContent.trim());let i=t||[...e];if(r&&!r.includes("All Items")){const e={"ü•¨ Produce":"produce","ü•õ Dairy & Eggs":"dairy","üçû Bakery":"bakery","ü•© Meat":"meat","ü•´ Pantry":"pantry","üßä Frozen":"frozen","ü•§ Beverages":"beverages"}[r];e&&(i=i.filter(t=>t.category===e))}if(n&&(i=i.filter(e=>e.name.toLowerCase().includes(n)||e.category.toLowerCase().includes(n))),"all"!==o){const[e,t]=o.split("-").map(Number);i=i.filter(n=>n.price>=e&&n.price<=t)}g(i)}function E(){const t=document.getElementById("sort-select");t&&(t.value="default");const n=document.getElementById("price-filter");n&&(n.value="all");const o=document.getElementById("in-stock-filter");o&&(o.checked=!1);const r=document.getElementById("search-input");r&&(r.value="");const i=document.querySelector(".category-btn");i&&(document.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),i.classList.add("active")),g(e)}function p(e,t){document.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),t&&t.classList.add("active"),h()}function f(){h()}function I(){const e=document.getElementById("cart-items"),t=document.getElementById("empty-cart"),n=document.getElementById("order-summary"),o=document.getElementById("cart-actions");if(e){if(0===r.length)return e.innerHTML="",t&&(t.style.display="block"),n&&(n.style.display="none"),void(o&&(o.style.display="none"));t&&(t.style.display="none"),n&&(n.style.display="block"),o&&(o.style.display="flex"),e.innerHTML=r.map(e=>`\n        <div class="cart-item">\n            <div class="cart-item-image">${e.imageUrl?`<img src="${e.imageUrl}" alt="${e.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`:e.emoji}</div>\n            <div class="cart-item-info">\n                <h3 class="cart-item-name">${e.name}</h3>\n                <p class="cart-item-price">$${e.price.toFixed(2)} each</p>\n            </div>\n            <div class="quantity-controls">\n                <button class="qty-btn" onclick="updateQuantity('${e.id}', -1)">‚àí</button>\n                <span class="qty-number">${e.quantity}</span>\n                <button class="qty-btn" onclick="updateQuantity('${e.id}', 1)">+</button>\n            </div>\n            <div class="cart-item-total">$${(e.price*e.quantity).toFixed(2)}</div>\n            <button class="remove-item-btn" onclick="removeFromCart('${e.id}')">√ó</button>\n        </div>\n        `).join(""),b()}}function b(){const e=r.reduce((e,t)=>e+t.price*t.quantity,0),t=parseFloat(document.getElementById("custom-tip")?.value||0)||0;let n=0;if("function"==typeof getValidatedPromoCode){const e=getValidatedPromoCode();e&&e.discount&&(n=e.discount)}const o=.084*(6.99+r.reduce((e,t)=>e+(t.isTaxable?t.price*t.quantity:0),0)),i=e+6.99+t+o-n,c=r.reduce((e,t)=>e+t.quantity,0),a=document.getElementById("summary-item-count"),s=document.getElementById("summary-subtotal"),d=document.getElementById("summary-tax"),l=document.getElementById("summary-total");a&&(a.textContent=c),s&&(s.textContent=e.toFixed(2)),d&&(d.textContent=o.toFixed(2)),l&&(l.textContent=i.toFixed(2))}async function w(e){if(e.preventDefault(),customerAuth.isLoggedIn()&&!customerAuth.isEmailVerified())return void message.showError("Please verify your email address before placing an order. Check your inbox for the verification link or go to your account to resend it.","Email Verification Required");const t=document.getElementById("name").value.trim(),n=document.getElementById("phone").value.trim(),o=document.getElementById("address").value.trim(),i=document.getElementById("email").value.trim(),a=document.getElementById("delivery-time").value,s=document.getElementById("notes").value.trim(),d=document.querySelector('input[name="payment"]:checked');if(!t||!n||!o)return void message.showError("Please fill in all required fields (name, phone, and address).","Missing Information");if(!d)return void message.showError("Please select a payment method.","Payment Method Required");const l=e.target.querySelector('button[type="submit"]');loading.buttonLoading(l,!0);const u=document.getElementById("checkout-progress");u&&progress.createStepProgress(u,["Validating","Processing","Confirming","Complete"],0);try{u&&progress.updateStepProgress(u,0),await new Promise(e=>setTimeout(e,500)),u&&progress.updateStepProgress(u,1);const e={customerInfo:{name:t,phone:n,email:i,address:o},items:r.map(e=>({productId:e.id,quantity:e.quantity})),delivery:{timePreference:a,instructions:s},payment:{method:d.value},notes:s},l=await api.createOrder(e,{showLoading:!1});if(u&&progress.updateStepProgress(u,2),await new Promise(e=>setTimeout(e,500)),!l.success||!l.order)throw new Error(l.message||"Failed to place order");{const e=l.order;u&&progress.updateStepProgress(u,3),await new Promise(e=>setTimeout(e,500)),message.showSuccess(`Your order #${e.orderId} has been placed successfully! Total: $${e.pricing.total.toFixed(2)}. We'll call ${n} within 30 minutes to confirm.`,"Order Placed! üéâ",null,8e3),r=[],c(),setTimeout(()=>{window.location.href=`track.html?phone=${encodeURIComponent(n)}`},2e3)}}catch(e){u&&(u.innerHTML="");let t="Something went wrong. Please try again.";e.message&&"Failed to place order"!==e.message&&(t=e.message),message.showError(t,"Order Failed"),loading.buttonLoading(l,!1)}}async function B(){const e=document.getElementById("track-phone"),t=e?e.value.trim():"";if(!t)return void toast.error("Please enter your phone number");const n=document.getElementById("order-status"),o=document.getElementById("no-order");loading.showOverlay("Finding your order...");try{const e=await fetch(`${API_CONFIG.BASE_URL}/orders/track/${encodeURIComponent(t)}`),r=await e.json();if(!e.ok||!r.success||!r.order)return n&&(n.style.display="none"),o?o.style.display="block":toast.info("No recent orders found for this phone number"),void loading.hideOverlay();const i=r.order;o&&(o.style.display="none"),n&&(n.style.display="block");const c=document.getElementById("order-id");c&&(c.textContent=i.orderId||i._id.substring(0,8),c.dataset.mongoId=i._id);const a=document.getElementById("order-date");a&&(a.textContent=new Date(i.createdAt).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit"}));const s=document.getElementById("order-total");if(s){const e=i.pricing?.total||i.totalAmount||i.total||0;s.textContent=e.toFixed(2)}const d=document.getElementById("placed-time");if(d&&(d.textContent=new Date(i.createdAt).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})),i.delivery&&i.delivery.driverId){const e=document.getElementById("driver-info");if(e){const t=i.delivery.driverId,n=`${t.firstName||""} ${t.lastName||""}`.trim()||"Your Driver",o=document.getElementById("driver-full-name");o&&(o.textContent=n);const r=document.getElementById("driver-vehicle");if(r&&(r.textContent=t.vehicle||"On the way"),i.delivery.pickedUpAt){e.style.display="block";const n=e.querySelector('a[href^="tel:"]');n&&t.phone&&(n.href=`tel:${t.phone}`)}}}L(i.status,i),x(i),C(i),loading.hideOverlay(),toast.success("Order found!")}catch(e){loading.hideOverlay(),toast.error("Error tracking order. Please try again.")}}function x(e){const t=document.getElementById("cancel-order-section");t&&(["placed","confirmed"].includes(e.status)&&!e.delivery?.pickedUpAt?t.style.display="block":t.style.display="none")}function C(e){if(window.io)try{const t=io(API_CONFIG.SOCKET_URL||"http://localhost:3000");t.on("connect",()=>{t.emit("track-order",{phone:e.customerInfo?.phone})}),t.on("order-status-changed",t=>{t.orderId!==e.orderId&&t._id!==e._id||(L(t.status,t),toast.success(`Order status updated: ${k(t.status)}`),window.location.pathname.includes("track.html")&&setTimeout(()=>B(),1e3))}),t.on("driver-assigned",t=>{t.orderId!==e.orderId&&t._id!==e._id||(toast.success("A driver has been assigned to your order!"),setTimeout(()=>B(),1e3))}),t.on("disconnect",()=>{})}catch(e){}}function L(e,t){const n={placed:["status-confirmed"],confirmed:["status-confirmed"],shopping:["status-confirmed","status-shopping"],delivering:["status-confirmed","status-shopping","status-delivering"],delivered:["status-confirmed","status-shopping","status-delivering","status-delivered"],cancelled:[]}[e]||[];["status-confirmed","status-shopping","status-delivering","status-delivered"].forEach(e=>{const t=document.getElementById(e);if(t){t.classList.remove("completed");const n=t.querySelector(".timeline-marker"),o={"status-confirmed":"2","status-shopping":"3","status-delivering":"4","status-delivered":"5"};n&&(n.textContent=o[e]||"")}}),n.forEach(e=>{const t=document.getElementById(e);if(t){t.classList.add("completed");const e=t.querySelector(".timeline-marker");e&&(e.textContent="‚úì")}}),"delivered"===e&&(document.getElementById("delivered-time").textContent="Just now!");const o=document.getElementById("cancel-order-section");o&&(o.style.display="placed"===e||"confirmed"===e?"block":"none")}function k(e){return{placed:"Order Placed",confirmed:"Order Confirmed",shopping:"Shopping in Progress",delivering:"Out for Delivery",delivered:"Delivered",cancelled:"Cancelled"}[e]||e}let q,$=null;function S(){const e=document.getElementById("cancel-modal");e&&(e.classList.add("active"),document.body.style.overflow="hidden")}function T(){const e=document.getElementById("cancel-modal");e&&(e.classList.remove("active"),document.body.style.overflow="",document.getElementById("cancel-reason").value="",document.getElementById("other-reason").value="",document.getElementById("other-reason-container").style.display="none")}async function P(){const e=document.getElementById("cancel-reason"),t=document.getElementById("other-reason"),n=document.getElementById("track-phone").value.trim();let o=e.value;if(!o)return void M("Please select a cancellation reason","error");if("other"===o){const e=t.value.trim();if(!e)return void M("Please specify your reason","error");o=e}const r=document.getElementById("order-id");if(!r)return void M("Order information not found","error");const i=r.dataset.mongoId;if(i)try{loading.showOverlay("Cancelling your order...");const e=await fetch(`${API_CONFIG.BASE_URL}/orders/${i}/cancel`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:o,phone:n})}),t=await e.json();if(!e.ok||!t.success)throw new Error(t.message||"Failed to cancel order");T(),M("‚úÖ Order Cancelled Successfully","success");const r=document.querySelector(".status-badge");r&&(r.textContent="‚ùå CANCELLED",r.style.background="#dc2626",r.style.color="white");const c=document.querySelector('button[onclick="showCancelModal()"]');c&&(c.style.display="none");const a=document.querySelector(".order-info-card");if(a){const e=document.createElement("div");e.style.cssText="background: #fee2e2; border: 2px solid #dc2626; border-radius: 12px; padding: 20px; margin-top: 20px; text-align: center;",e.innerHTML='\n                <h3 style="color: #dc2626; margin: 0 0 10px 0; font-size: 22px;">\n                    ‚úÖ Your order has been cancelled\n                </h3>\n                <p style="font-size: 18px; margin: 0; color: #1f2937;">\n                    No charges will be made to your account. You will receive a confirmation email shortly.\n                </p>\n            ',a.appendChild(e)}setTimeout(()=>{B()},2e3)}catch(e){M(e.message||"Failed to cancel order. Please contact us directly.","error")}finally{loading.hideOverlay()}else M("Order ID not available","error")}function O(){document.body.classList.toggle("large-text");const e=document.getElementById("text-size-btn");e&&(e.textContent=document.body.classList.contains("large-text")?"üî§ Normal Text":"üî§ Larger Text"),localStorage.setItem("largeText",document.body.classList.contains("large-text"))}function F(){document.body.classList.toggle("high-contrast"),localStorage.setItem("highContrast",document.body.classList.contains("high-contrast"))}function A(){if(!("speechSynthesis"in window))return void M("Text-to-speech not supported in your browser","error");speechSynthesis.cancel();const e=(document.querySelector("main")||document.body).innerText,t=new SpeechSynthesisUtterance(e);t.rate=.9,t.pitch=1,speechSynthesis.speak(t),M("üîä Reading page aloud...","success")}function U(){const e=document.getElementById("main-nav");e&&e.classList.toggle("active")}function M(e,t="success"){const n=document.querySelector(".toast");n&&n.remove();const o=document.createElement("div");o.className=`toast ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},3e3)}function j(e){const t=document.getElementById("custom-tip");t&&(t.value=e),document.querySelectorAll(".tip-btn").forEach(t=>{parseInt(t.dataset.tip)===e?(t.style.background="#f59e0b",t.style.color="white",t.style.borderColor="#d97706"):(t.style.background="white",t.style.color="#713f12",t.style.borderColor="#d97706")}),D(e),b()}function N(){const e=document.getElementById("custom-tip"),t=parseFloat(e.value)||0;document.querySelectorAll(".tip-btn").forEach(e=>{e.style.background="white",e.style.color="#713f12",e.style.borderColor="#d97706"}),D(t),b()}function D(e){const t=document.getElementById("tip-display"),n=document.getElementById("selected-tip-amount");t&&n&&(e>0?(n.textContent=e.toFixed(2),t.style.display="block"):t.style.display="none")}function _(t){try{const n=e.find(e=>e.id===t);if(!n)return;const o=document.getElementById("quick-view-modal");if(!o)return void M("‚ö†Ô∏è Quick view not available on this page","error");if(["qv-image","qv-name","qv-price","qv-category","qv-quantity","qv-add-btn"].filter(e=>!document.getElementById(e)).length>0)return void M("‚ö†Ô∏è Quick view is not properly configured","error");const r=n.imageUrl?`<img src="${n.imageUrl}" alt="${n.name}">`:n.emoji;document.getElementById("qv-image").innerHTML=r,document.getElementById("qv-name").textContent=n.name,document.getElementById("qv-price").textContent=`$${n.price.toFixed(2)}`,document.getElementById("qv-category").textContent=n.category,document.getElementById("qv-quantity").value=1,document.getElementById("qv-add-btn").onclick=()=>{const e=parseInt(document.getElementById("qv-quantity").value);for(let n=0;n<e;n++)d(t);H(),M(`‚úÖ Added ${e} ${n.name} to cart!`,"success")},o.classList.add("active"),document.body.style.overflow="hidden";const i=e=>{"Escape"===e.key&&(H(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),o.onclick=e=>{e.target===o&&H()}}catch(e){M("‚ö†Ô∏è Unable to open quick view","error"),document.body.style.overflow="auto"}}function H(){const e=document.getElementById("quick-view-modal");e&&e.classList.remove("active"),document.body.style.overflow="auto"}function R(e){const t=document.getElementById("qv-quantity"),n=parseInt(t.value),o=Math.max(1,Math.min(99,n+e));t.value=o}function V(){const t=document.getElementById("search-input");if(!t)return;const n=document.createElement("div");n.id="search-autocomplete",n.className="search-autocomplete",t.parentNode.style.position="relative",t.parentNode.appendChild(n),t.addEventListener("input",t=>{clearTimeout(q);const o=t.target.value.toLowerCase().trim();if(o.length<2)return n.innerHTML="",void(n.style.display="none");q=setTimeout(()=>{const t=e.filter(e=>e.name.toLowerCase().includes(o)||e.category.toLowerCase().includes(o)).slice(0,5);if(0===t.length)return n.innerHTML="",void(n.style.display="none");n.innerHTML=t.map(e=>{const t=e.imageUrl?`<img src="${e.imageUrl}" alt="${e.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">`:`<span style="font-size: 32px;">${e.emoji}</span>`;return`\n                    <div class="autocomplete-item" onclick="selectSearchItem('${e.id}', '${e.name.replace(/'/g,"\\'")}')">\n                        <div class="autocomplete-image">${t}</div>\n                        <div class="autocomplete-details">\n                            <div class="autocomplete-name">${z(e.name,o)}</div>\n                            <div class="autocomplete-meta">${e.category} ‚Ä¢ $${e.price.toFixed(2)}</div>\n                        </div>\n                        <button class="autocomplete-add" onclick="event.stopPropagation(); addToCart('${e.id}'); closeAutocomplete();">+</button>\n                    </div>\n                `}).join(""),n.style.display="block"},300)}),document.addEventListener("click",e=>{t.contains(e.target)||n.contains(e.target)||(n.style.display="none")})}function z(e,t){const n=new RegExp(`(${t})`,"gi");return e.replace(n,"<strong>$1</strong>")}function Q(e,t){const n=document.getElementById("search-input");n&&(n.value=t,h(),Y())}function Y(){const e=document.getElementById("search-autocomplete");e&&(e.style.display="none")}window.showCancelModal=S,window.closeCancelModal=T,document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("cancel-reason");e&&e.addEventListener("change",function(){const e=document.getElementById("other-reason-container");"other"===this.value?e.style.display="block":e.style.display="none"})}),window.confirmCancelOrder=P,document.addEventListener("DOMContentLoaded",function(){i(),document.getElementById("grocery-grid")&&g();const e=document.getElementById("checkout-form");if(e&&"undefined"==typeof handleCheckoutSubmit&&e.addEventListener("submit",w),"true"===localStorage.getItem("largeText")){document.body.classList.add("large-text");const e=document.getElementById("text-size-btn");e&&(e.textContent="üî§ Normal Text")}"true"===localStorage.getItem("highContrast")&&document.body.classList.add("high-contrast")}),document.getElementById("search-input")&&0===e.length?setTimeout(()=>{e.length>0&&V()},1e3):document.getElementById("search-input")&&V();